// ==UserScript==
// @name          discobolus
// @author        Jeremie Jarosh
// @namespace     http://trejeraos.com/
// @description   A third party add-on for the website dcbservice.com
// @version       0.1.4
// @include       http://dcbservice.com/*
// @include       http://www.dcbservice.com/*
// @include       https://dcbservice.com/*
// @include       https://www.dcbservice.com/*
// ==/UserScript==

var htmlClass = "discobolus"

var elmHead = document.head;
var elmHtml = document.body.parentElement;
var elmStyle;
var elmScript;

var stylesDataUrl = "data:text/css;charset=utf-8;base64,LmRpc2NvYm9sdXMgLmhpZGRlbiB7CiAgZGlzcGxheTogbm9uZTsKfQpAbWVkaWEgc2NyZWVuIGFuZCAobWluLXdpZHRoOiAxMzg0cHgpIHsKICAuZGlzY29ib2x1cyAuY29udGVudC13cmFwcGVyIHsKICAgIHdpZHRoOiAxMzUwcHg7CiAgfQogIC5kaXNjb2JvbHVzIC5yaWdodGNvbCB7CiAgICB3aWR0aDogMTA3NHB4OwogIH0KICAuZGlzY29ib2x1cyAuY29udHJvbHN0cmlwIHsKICAgIGJhY2tncm91bmQtc2l6ZTogMTEwMXB4IDY0cHg7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uLXg6IC01cHg7CiAgfQogIC5kaXNjb2JvbHVzIC5wcm9kdWN0ZGV0YWlsIGgxLnRpdGxlIHsKICAgIHdpZHRoOiA4MjBweDsKICB9CiAgLmRpc2NvYm9sdXMgLmRldGFpbGRhdGFjb2wgewogICAgd2lkdGg6IDQ0MHB4OwogIH0KfQpAbWVkaWEgc2NyZWVuIGFuZCAobWluLXdpZHRoOiAxNzQycHgpIHsKICAuZGlzY29ib2x1cyAuY29udGVudC13cmFwcGVyIHsKICAgIHdpZHRoOiAxNzA4cHg7CiAgfQogIC5kaXNjb2JvbHVzIC5yaWdodGNvbCB7CiAgICB3aWR0aDogMTQzMnB4OwogIH0KICAuZGlzY29ib2x1cyAuY29udHJvbHN0cmlwIHsKICAgIGJhY2tncm91bmQtc2l6ZTogMTQ2OXB4IDY0cHg7CiAgICBiYWNrZ3JvdW5kLXBvc2l0aW9uLXg6IC0xMHB4OwogIH0KfQouZGlzY29ib2x1cyAjZGNic21lbnUgewogIGJhY2tncm91bmQtY29sb3I6ICMwMDA0MGU7Cn0KQG1lZGlhIHNjcmVlbiBhbmQgKG1pbi13aWR0aDogMTM4NHB4KSB7CiAgLmRpc2NvYm9sdXMgLmhlYWRtZW51IHsKICAgIHdpZHRoOiAxMzUwcHg7CiAgfQogIC5kaXNjb2JvbHVzICNkY2JzbWVudSB7CiAgICBiYWNrZ3JvdW5kLWltYWdlOiB1cmwoJ2h0dHBzOi8vd3d3LmRjYnNlcnZpY2UuY29tL2NvbnRlbnQvbWVudWJhcjIvdHJhZGVwYXBlcmJhY2tzLnBuZycpOwogICAgYmFja2dyb3VuZC1yZXBlYXQ6IG5vLXJlcGVhdDsKICAgIGJhY2tncm91bmQtcG9zaXRpb246IDY4NXB4IDBweDsKICAgIGJhY2tncm91bmQtc2l6ZTogMzYzcHggMzZweDsKICB9CiAgLmRpc2NvYm9sdXMgI25hdnNlYXJjaGJveGJnLAogIC5kaXNjb2JvbHVzICNuYXZzZWFyY2ggewogICAgZmxvYXQ6IG5vbmU7CiAgICBwb3NpdGlvbjogYWJzb2x1dGU7CiAgICB0b3A6IDBweDsKICB9CiAgLmRpc2NvYm9sdXMgI25hdnNlYXJjaGJveGJnIHsKICAgIHJpZ2h0OiA0OHB4OwogIH0KICAuZGlzY29ib2x1cyAjbmF2c2VhcmNoIHsKICAgIHJpZ2h0OiAwcHg7CiAgfQp9CkBtZWRpYSBzY3JlZW4gYW5kIChtaW4td2lkdGg6IDE3NDJweCkgewogIC5kaXNjb2JvbHVzIC5oZWFkbWVudSB7CiAgICB3aWR0aDogMTcwOHB4OwogIH0KICAuZGlzY29ib2x1cyAjZGNic21lbnUgewogICAgYmFja2dyb3VuZC1zaXplOiA3MjNweCAzNnB4OwogIH0KfQouZGlzY29ib2x1cy5pbmZpbml0ZS1zY3JvbGwgdWwucGFnZXIgewogIHZpc2liaWxpdHk6IGhpZGRlbjsKfQouZGlzY29ib2x1cy5pbmZpbml0ZS1zY3JvbGwgLmluZmluaXRlLXNjcm9sbC1sb2FkaW5nIHsKICBjbGVhcjogYm90aDsKICBwb3NpdGlvbjogcmVsYXRpdmU7CiAgaGVpZ2h0OiAyLjVlbTsKICBib3gtc2l6aW5nOiBib3JkZXItYm94OwogIHRleHQtYWxpZ246IGNlbnRlcjsKICBiYWNrZ3JvdW5kLWNvbG9yOiAjMTYxYzJhOwogIGJvcmRlcjogMXB4IHNvbGlkICMwMDA7CiAgY29sb3I6IHdoaXRlOwogIG1hcmdpbjogMHB4OwogIHBhZGRpbmc6IDNweDsKICB0cmFuc2l0aW9uOiBvcGFjaXR5IDAuM3MgZWFzZS1pbi1vdXQ7CiAgb3BhY2l0eTogMDsKfQouZGlzY29ib2x1cy5pbmZpbml0ZS1zY3JvbGwgLmluZmluaXRlLXNjcm9sbC1sb2FkaW5nOjphZnRlciB7CiAgY29udGVudDogIiAiOwogIHBvc2l0aW9uOiBhYnNvbHV0ZTsKICBsaW5lLWhlaWdodDogMWVtOwogIHRvcDogMC43NWVtOwogIGxlZnQ6IDBweDsKICByaWdodDogMHB4Owp9Ci5kaXNjb2JvbHVzLmluZmluaXRlLXNjcm9sbCAuaW5maW5pdGUtc2Nyb2xsLWxvYWRpbmcuYWN0aXZlIHsKICBvcGFjaXR5OiAxOwp9Ci5kaXNjb2JvbHVzLmluZmluaXRlLXNjcm9sbCAuaW5maW5pdGUtc2Nyb2xsLWxvYWRpbmcuYWN0aXZlOjphZnRlciB7CiAgY29udGVudDogIkxvYWRpbmfigKYiOwogIGFuaW1hdGlvbjogcHVsc2F0ZSAzcyBlYXNlLW91dCBpbmZpbml0ZTsKICBvcGFjaXR5OiAwLjU7Cn0KQGtleWZyYW1lcyBwdWxzYXRlIHsKICAwJSB7CiAgICBvcGFjaXR5OiAwLjU7CiAgfQogIDUwJSB7CiAgICBvcGFjaXR5OiAxOwogIH0KICAxMDAlIHsKICAgIG9wYWNpdHk6IDAuNTsKICB9Cn0KLmRpc2NvYm9sdXMgLnRodW1ibGlzdC5oaWdobGlnaHQtbmV3LXNlcmllcyBsaTpub3QoLm5ldy1zZXJpZXMpLAouZGlzY29ib2x1cyAudGh1bWJsaXN0LmhpZ2hsaWdodC1uZXctc2VyaWVzIC5yZWxpc3QubmV3LXNlcmllcywKLmRpc2NvYm9sdXMgLnRodW1ibGlzdC5oaWdobGlnaHQtbmV3LXNlcmllcyAuZXhpc3Rpbmctc2VyaWVzIHsKICBkaXNwbGF5OiBub25lOwp9Ci5kaXNjb2JvbHVzIC5oaWdobGlnaHQtbmV3LXNlcmllcy1jb250cm9sID4gaW5wdXRbdHlwZT1jaGVja2JveF0gewogIG1hcmdpbjogMHB4IDZweDsKICB3aWR0aDogdW5zZXQ7CiAgaGVpZ2h0OiB1bnNldDsKfQouZGlzY29ib2x1cyAub3JkZXJsaXN0IC5vcmRlci1zdGF0dXMgPiBzcGFuOjpiZWZvcmUgewogIGNvbnRlbnQ6ICIvIjsKICBwYWRkaW5nOiAwIDAuMmVtOwogIG9wYWNpdHk6IDAuNTsKfQouZGlzY29ib2x1cyAub3JkZXJsaXN0IC5vcmRlci1zdGF0dXMgPiBzcGFuOmZpcnN0LWNoaWxkOjpiZWZvcmUgewogIGNvbnRlbnQ6ICIiOwp9Ci5kaXNjb2JvbHVzIC51c2Vyc2NyaXB0LXNldHRpbmdzLWxpbmsgewogIGZvbnQtc3R5bGU6IGl0YWxpYzsKfQo=";
var scriptDataUrl = "data:text/javascript;charset=utf-8;base64,KGZ1bmN0aW9uKCl7ZnVuY3Rpb24gcihlLG4sdCl7ZnVuY3Rpb24gbyhpLGYpe2lmKCFuW2ldKXtpZighZVtpXSl7dmFyIGM9ImZ1bmN0aW9uIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmU7aWYoIWYmJmMpcmV0dXJuIGMoaSwhMCk7aWYodSlyZXR1cm4gdShpLCEwKTt2YXIgYT1uZXcgRXJyb3IoIkNhbm5vdCBmaW5kIG1vZHVsZSAnIitpKyInIik7dGhyb3cgYS5jb2RlPSJNT0RVTEVfTk9UX0ZPVU5EIixhfXZhciBwPW5baV09e2V4cG9ydHM6e319O2VbaV1bMF0uY2FsbChwLmV4cG9ydHMsZnVuY3Rpb24ocil7dmFyIG49ZVtpXVsxXVtyXTtyZXR1cm4gbyhufHxyKX0scCxwLmV4cG9ydHMscixlLG4sdCl9cmV0dXJuIG5baV0uZXhwb3J0c31mb3IodmFyIHU9ImZ1bmN0aW9uIj09dHlwZW9mIHJlcXVpcmUmJnJlcXVpcmUsaT0wO2k8dC5sZW5ndGg7aSsrKW8odFtpXSk7cmV0dXJuIG99cmV0dXJuIHJ9KSgpKHsxOltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKIWZ1bmN0aW9uKCkgewogICAgJ3VzZSBzdHJpY3QnOwogICAgZnVuY3Rpb24gaChub2RlTmFtZSwgYXR0cmlidXRlcykgewogICAgICAgIHZhciBsYXN0U2ltcGxlLCBjaGlsZCwgc2ltcGxlLCBpLCBjaGlsZHJlbiA9IEVNUFRZX0NISUxEUkVOOwogICAgICAgIGZvciAoaSA9IGFyZ3VtZW50cy5sZW5ndGg7IGktLSA+IDI7ICkgc3RhY2sucHVzaChhcmd1bWVudHNbaV0pOwogICAgICAgIGlmIChhdHRyaWJ1dGVzICYmIG51bGwgIT0gYXR0cmlidXRlcy5jaGlsZHJlbikgewogICAgICAgICAgICBpZiAoIXN0YWNrLmxlbmd0aCkgc3RhY2sucHVzaChhdHRyaWJ1dGVzLmNoaWxkcmVuKTsKICAgICAgICAgICAgZGVsZXRlIGF0dHJpYnV0ZXMuY2hpbGRyZW47CiAgICAgICAgfQogICAgICAgIHdoaWxlIChzdGFjay5sZW5ndGgpIGlmICgoY2hpbGQgPSBzdGFjay5wb3AoKSkgJiYgdm9pZCAwICE9PSBjaGlsZC5wb3ApIGZvciAoaSA9IGNoaWxkLmxlbmd0aDsgaS0tOyApIHN0YWNrLnB1c2goY2hpbGRbaV0pOyBlbHNlIHsKICAgICAgICAgICAgaWYgKCdib29sZWFuJyA9PSB0eXBlb2YgY2hpbGQpIGNoaWxkID0gbnVsbDsKICAgICAgICAgICAgaWYgKHNpbXBsZSA9ICdmdW5jdGlvbicgIT0gdHlwZW9mIG5vZGVOYW1lKSBpZiAobnVsbCA9PSBjaGlsZCkgY2hpbGQgPSAnJzsgZWxzZSBpZiAoJ251bWJlcicgPT0gdHlwZW9mIGNoaWxkKSBjaGlsZCA9IFN0cmluZyhjaGlsZCk7IGVsc2UgaWYgKCdzdHJpbmcnICE9IHR5cGVvZiBjaGlsZCkgc2ltcGxlID0gITE7CiAgICAgICAgICAgIGlmIChzaW1wbGUgJiYgbGFzdFNpbXBsZSkgY2hpbGRyZW5bY2hpbGRyZW4ubGVuZ3RoIC0gMV0gKz0gY2hpbGQ7IGVsc2UgaWYgKGNoaWxkcmVuID09PSBFTVBUWV9DSElMRFJFTikgY2hpbGRyZW4gPSBbIGNoaWxkIF07IGVsc2UgY2hpbGRyZW4ucHVzaChjaGlsZCk7CiAgICAgICAgICAgIGxhc3RTaW1wbGUgPSBzaW1wbGU7CiAgICAgICAgfQogICAgICAgIHZhciBwID0gbmV3IFZOb2RlKCk7CiAgICAgICAgcC5ub2RlTmFtZSA9IG5vZGVOYW1lOwogICAgICAgIHAuY2hpbGRyZW4gPSBjaGlsZHJlbjsKICAgICAgICBwLmF0dHJpYnV0ZXMgPSBudWxsID09IGF0dHJpYnV0ZXMgPyB2b2lkIDAgOiBhdHRyaWJ1dGVzOwogICAgICAgIHAua2V5ID0gbnVsbCA9PSBhdHRyaWJ1dGVzID8gdm9pZCAwIDogYXR0cmlidXRlcy5rZXk7CiAgICAgICAgaWYgKHZvaWQgMCAhPT0gb3B0aW9ucy52bm9kZSkgb3B0aW9ucy52bm9kZShwKTsKICAgICAgICByZXR1cm4gcDsKICAgIH0KICAgIGZ1bmN0aW9uIGV4dGVuZChvYmosIHByb3BzKSB7CiAgICAgICAgZm9yICh2YXIgaSBpbiBwcm9wcykgb2JqW2ldID0gcHJvcHNbaV07CiAgICAgICAgcmV0dXJuIG9iajsKICAgIH0KICAgIGZ1bmN0aW9uIGFwcGx5UmVmKHJlZiwgdmFsdWUpIHsKICAgICAgICBpZiAobnVsbCAhPSByZWYpIGlmICgnZnVuY3Rpb24nID09IHR5cGVvZiByZWYpIHJlZih2YWx1ZSk7IGVsc2UgcmVmLmN1cnJlbnQgPSB2YWx1ZTsKICAgIH0KICAgIGZ1bmN0aW9uIGNsb25lRWxlbWVudCh2bm9kZSwgcHJvcHMpIHsKICAgICAgICByZXR1cm4gaCh2bm9kZS5ub2RlTmFtZSwgZXh0ZW5kKGV4dGVuZCh7fSwgdm5vZGUuYXR0cmlidXRlcyksIHByb3BzKSwgYXJndW1lbnRzLmxlbmd0aCA+IDIgPyBbXS5zbGljZS5jYWxsKGFyZ3VtZW50cywgMikgOiB2bm9kZS5jaGlsZHJlbik7CiAgICB9CiAgICBmdW5jdGlvbiBlbnF1ZXVlUmVuZGVyKGNvbXBvbmVudCkgewogICAgICAgIGlmICghY29tcG9uZW50Ll9fZCAmJiAoY29tcG9uZW50Ll9fZCA9ICEwKSAmJiAxID09IGl0ZW1zLnB1c2goY29tcG9uZW50KSkgKG9wdGlvbnMuZGVib3VuY2VSZW5kZXJpbmcgfHwgZGVmZXIpKHJlcmVuZGVyKTsKICAgIH0KICAgIGZ1bmN0aW9uIHJlcmVuZGVyKCkgewogICAgICAgIHZhciBwOwogICAgICAgIHdoaWxlIChwID0gaXRlbXMucG9wKCkpIGlmIChwLl9fZCkgcmVuZGVyQ29tcG9uZW50KHApOwogICAgfQogICAgZnVuY3Rpb24gaXNTYW1lTm9kZVR5cGUobm9kZSwgdm5vZGUsIGh5ZHJhdGluZykgewogICAgICAgIGlmICgnc3RyaW5nJyA9PSB0eXBlb2Ygdm5vZGUgfHwgJ251bWJlcicgPT0gdHlwZW9mIHZub2RlKSByZXR1cm4gdm9pZCAwICE9PSBub2RlLnNwbGl0VGV4dDsKICAgICAgICBpZiAoJ3N0cmluZycgPT0gdHlwZW9mIHZub2RlLm5vZGVOYW1lKSByZXR1cm4gIW5vZGUuX2NvbXBvbmVudENvbnN0cnVjdG9yICYmIGlzTmFtZWROb2RlKG5vZGUsIHZub2RlLm5vZGVOYW1lKTsgZWxzZSByZXR1cm4gaHlkcmF0aW5nIHx8IG5vZGUuX2NvbXBvbmVudENvbnN0cnVjdG9yID09PSB2bm9kZS5ub2RlTmFtZTsKICAgIH0KICAgIGZ1bmN0aW9uIGlzTmFtZWROb2RlKG5vZGUsIG5vZGVOYW1lKSB7CiAgICAgICAgcmV0dXJuIG5vZGUuX19uID09PSBub2RlTmFtZSB8fCBub2RlLm5vZGVOYW1lLnRvTG93ZXJDYXNlKCkgPT09IG5vZGVOYW1lLnRvTG93ZXJDYXNlKCk7CiAgICB9CiAgICBmdW5jdGlvbiBnZXROb2RlUHJvcHModm5vZGUpIHsKICAgICAgICB2YXIgcHJvcHMgPSBleHRlbmQoe30sIHZub2RlLmF0dHJpYnV0ZXMpOwogICAgICAgIHByb3BzLmNoaWxkcmVuID0gdm5vZGUuY2hpbGRyZW47CiAgICAgICAgdmFyIGRlZmF1bHRQcm9wcyA9IHZub2RlLm5vZGVOYW1lLmRlZmF1bHRQcm9wczsKICAgICAgICBpZiAodm9pZCAwICE9PSBkZWZhdWx0UHJvcHMpIGZvciAodmFyIGkgaW4gZGVmYXVsdFByb3BzKSBpZiAodm9pZCAwID09PSBwcm9wc1tpXSkgcHJvcHNbaV0gPSBkZWZhdWx0UHJvcHNbaV07CiAgICAgICAgcmV0dXJuIHByb3BzOwogICAgfQogICAgZnVuY3Rpb24gY3JlYXRlTm9kZShub2RlTmFtZSwgaXNTdmcpIHsKICAgICAgICB2YXIgbm9kZSA9IGlzU3ZnID8gZG9jdW1lbnQuY3JlYXRlRWxlbWVudE5TKCdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZycsIG5vZGVOYW1lKSA6IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQobm9kZU5hbWUpOwogICAgICAgIG5vZGUuX19uID0gbm9kZU5hbWU7CiAgICAgICAgcmV0dXJuIG5vZGU7CiAgICB9CiAgICBmdW5jdGlvbiByZW1vdmVOb2RlKG5vZGUpIHsKICAgICAgICB2YXIgcGFyZW50Tm9kZSA9IG5vZGUucGFyZW50Tm9kZTsKICAgICAgICBpZiAocGFyZW50Tm9kZSkgcGFyZW50Tm9kZS5yZW1vdmVDaGlsZChub2RlKTsKICAgIH0KICAgIGZ1bmN0aW9uIHNldEFjY2Vzc29yKG5vZGUsIG5hbWUsIG9sZCwgdmFsdWUsIGlzU3ZnKSB7CiAgICAgICAgaWYgKCdjbGFzc05hbWUnID09PSBuYW1lKSBuYW1lID0gJ2NsYXNzJzsKICAgICAgICBpZiAoJ2tleScgPT09IG5hbWUpIDsgZWxzZSBpZiAoJ3JlZicgPT09IG5hbWUpIHsKICAgICAgICAgICAgYXBwbHlSZWYob2xkLCBudWxsKTsKICAgICAgICAgICAgYXBwbHlSZWYodmFsdWUsIG5vZGUpOwogICAgICAgIH0gZWxzZSBpZiAoJ2NsYXNzJyA9PT0gbmFtZSAmJiAhaXNTdmcpIG5vZGUuY2xhc3NOYW1lID0gdmFsdWUgfHwgJyc7IGVsc2UgaWYgKCdzdHlsZScgPT09IG5hbWUpIHsKICAgICAgICAgICAgaWYgKCF2YWx1ZSB8fCAnc3RyaW5nJyA9PSB0eXBlb2YgdmFsdWUgfHwgJ3N0cmluZycgPT0gdHlwZW9mIG9sZCkgbm9kZS5zdHlsZS5jc3NUZXh0ID0gdmFsdWUgfHwgJyc7CiAgICAgICAgICAgIGlmICh2YWx1ZSAmJiAnb2JqZWN0JyA9PSB0eXBlb2YgdmFsdWUpIHsKICAgICAgICAgICAgICAgIGlmICgnc3RyaW5nJyAhPSB0eXBlb2Ygb2xkKSBmb3IgKHZhciBpIGluIG9sZCkgaWYgKCEoaSBpbiB2YWx1ZSkpIG5vZGUuc3R5bGVbaV0gPSAnJzsKICAgICAgICAgICAgICAgIGZvciAodmFyIGkgaW4gdmFsdWUpIG5vZGUuc3R5bGVbaV0gPSAnbnVtYmVyJyA9PSB0eXBlb2YgdmFsdWVbaV0gJiYgITEgPT09IElTX05PTl9ESU1FTlNJT05BTC50ZXN0KGkpID8gdmFsdWVbaV0gKyAncHgnIDogdmFsdWVbaV07CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgaWYgKCdkYW5nZXJvdXNseVNldElubmVySFRNTCcgPT09IG5hbWUpIHsKICAgICAgICAgICAgaWYgKHZhbHVlKSBub2RlLmlubmVySFRNTCA9IHZhbHVlLl9faHRtbCB8fCAnJzsKICAgICAgICB9IGVsc2UgaWYgKCdvJyA9PSBuYW1lWzBdICYmICduJyA9PSBuYW1lWzFdKSB7CiAgICAgICAgICAgIHZhciB1c2VDYXB0dXJlID0gbmFtZSAhPT0gKG5hbWUgPSBuYW1lLnJlcGxhY2UoL0NhcHR1cmUkLywgJycpKTsKICAgICAgICAgICAgbmFtZSA9IG5hbWUudG9Mb3dlckNhc2UoKS5zdWJzdHJpbmcoMik7CiAgICAgICAgICAgIGlmICh2YWx1ZSkgewogICAgICAgICAgICAgICAgaWYgKCFvbGQpIG5vZGUuYWRkRXZlbnRMaXN0ZW5lcihuYW1lLCBldmVudFByb3h5LCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgfSBlbHNlIG5vZGUucmVtb3ZlRXZlbnRMaXN0ZW5lcihuYW1lLCBldmVudFByb3h5LCB1c2VDYXB0dXJlKTsKICAgICAgICAgICAgKG5vZGUuX19sIHx8IChub2RlLl9fbCA9IHt9KSlbbmFtZV0gPSB2YWx1ZTsKICAgICAgICB9IGVsc2UgaWYgKCdsaXN0JyAhPT0gbmFtZSAmJiAndHlwZScgIT09IG5hbWUgJiYgIWlzU3ZnICYmIG5hbWUgaW4gbm9kZSkgewogICAgICAgICAgICB0cnkgewogICAgICAgICAgICAgICAgbm9kZVtuYW1lXSA9IG51bGwgPT0gdmFsdWUgPyAnJyA6IHZhbHVlOwogICAgICAgICAgICB9IGNhdGNoIChlKSB7fQogICAgICAgICAgICBpZiAoKG51bGwgPT0gdmFsdWUgfHwgITEgPT09IHZhbHVlKSAmJiAnc3BlbGxjaGVjaycgIT0gbmFtZSkgbm9kZS5yZW1vdmVBdHRyaWJ1dGUobmFtZSk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgdmFyIG5zID0gaXNTdmcgJiYgbmFtZSAhPT0gKG5hbWUgPSBuYW1lLnJlcGxhY2UoL154bGluazo/LywgJycpKTsKICAgICAgICAgICAgaWYgKG51bGwgPT0gdmFsdWUgfHwgITEgPT09IHZhbHVlKSBpZiAobnMpIG5vZGUucmVtb3ZlQXR0cmlidXRlTlMoJ2h0dHA6Ly93d3cudzMub3JnLzE5OTkveGxpbmsnLCBuYW1lLnRvTG93ZXJDYXNlKCkpOyBlbHNlIG5vZGUucmVtb3ZlQXR0cmlidXRlKG5hbWUpOyBlbHNlIGlmICgnZnVuY3Rpb24nICE9IHR5cGVvZiB2YWx1ZSkgaWYgKG5zKSBub2RlLnNldEF0dHJpYnV0ZU5TKCdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJywgbmFtZS50b0xvd2VyQ2FzZSgpLCB2YWx1ZSk7IGVsc2Ugbm9kZS5zZXRBdHRyaWJ1dGUobmFtZSwgdmFsdWUpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGV2ZW50UHJveHkoZSkgewogICAgICAgIHJldHVybiB0aGlzLl9fbFtlLnR5cGVdKG9wdGlvbnMuZXZlbnQgJiYgb3B0aW9ucy5ldmVudChlKSB8fCBlKTsKICAgIH0KICAgIGZ1bmN0aW9uIGZsdXNoTW91bnRzKCkgewogICAgICAgIHZhciBjOwogICAgICAgIHdoaWxlIChjID0gbW91bnRzLnNoaWZ0KCkpIHsKICAgICAgICAgICAgaWYgKG9wdGlvbnMuYWZ0ZXJNb3VudCkgb3B0aW9ucy5hZnRlck1vdW50KGMpOwogICAgICAgICAgICBpZiAoYy5jb21wb25lbnREaWRNb3VudCkgYy5jb21wb25lbnREaWRNb3VudCgpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIGRpZmYoZG9tLCB2bm9kZSwgY29udGV4dCwgbW91bnRBbGwsIHBhcmVudCwgY29tcG9uZW50Um9vdCkgewogICAgICAgIGlmICghZGlmZkxldmVsKyspIHsKICAgICAgICAgICAgaXNTdmdNb2RlID0gbnVsbCAhPSBwYXJlbnQgJiYgdm9pZCAwICE9PSBwYXJlbnQub3duZXJTVkdFbGVtZW50OwogICAgICAgICAgICBoeWRyYXRpbmcgPSBudWxsICE9IGRvbSAmJiAhKCdfX3ByZWFjdGF0dHJfJyBpbiBkb20pOwogICAgICAgIH0KICAgICAgICB2YXIgcmV0ID0gaWRpZmYoZG9tLCB2bm9kZSwgY29udGV4dCwgbW91bnRBbGwsIGNvbXBvbmVudFJvb3QpOwogICAgICAgIGlmIChwYXJlbnQgJiYgcmV0LnBhcmVudE5vZGUgIT09IHBhcmVudCkgcGFyZW50LmFwcGVuZENoaWxkKHJldCk7CiAgICAgICAgaWYgKCEtLWRpZmZMZXZlbCkgewogICAgICAgICAgICBoeWRyYXRpbmcgPSAhMTsKICAgICAgICAgICAgaWYgKCFjb21wb25lbnRSb290KSBmbHVzaE1vdW50cygpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmV0OwogICAgfQogICAgZnVuY3Rpb24gaWRpZmYoZG9tLCB2bm9kZSwgY29udGV4dCwgbW91bnRBbGwsIGNvbXBvbmVudFJvb3QpIHsKICAgICAgICB2YXIgb3V0ID0gZG9tLCBwcmV2U3ZnTW9kZSA9IGlzU3ZnTW9kZTsKICAgICAgICBpZiAobnVsbCA9PSB2bm9kZSB8fCAnYm9vbGVhbicgPT0gdHlwZW9mIHZub2RlKSB2bm9kZSA9ICcnOwogICAgICAgIGlmICgnc3RyaW5nJyA9PSB0eXBlb2Ygdm5vZGUgfHwgJ251bWJlcicgPT0gdHlwZW9mIHZub2RlKSB7CiAgICAgICAgICAgIGlmIChkb20gJiYgdm9pZCAwICE9PSBkb20uc3BsaXRUZXh0ICYmIGRvbS5wYXJlbnROb2RlICYmICghZG9tLl9jb21wb25lbnQgfHwgY29tcG9uZW50Um9vdCkpIHsKICAgICAgICAgICAgICAgIGlmIChkb20ubm9kZVZhbHVlICE9IHZub2RlKSBkb20ubm9kZVZhbHVlID0gdm5vZGU7CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBvdXQgPSBkb2N1bWVudC5jcmVhdGVUZXh0Tm9kZSh2bm9kZSk7CiAgICAgICAgICAgICAgICBpZiAoZG9tKSB7CiAgICAgICAgICAgICAgICAgICAgaWYgKGRvbS5wYXJlbnROb2RlKSBkb20ucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQob3V0LCBkb20pOwogICAgICAgICAgICAgICAgICAgIHJlY29sbGVjdE5vZGVUcmVlKGRvbSwgITApOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIG91dC5fX3ByZWFjdGF0dHJfID0gITA7CiAgICAgICAgICAgIHJldHVybiBvdXQ7CiAgICAgICAgfQogICAgICAgIHZhciB2bm9kZU5hbWUgPSB2bm9kZS5ub2RlTmFtZTsKICAgICAgICBpZiAoJ2Z1bmN0aW9uJyA9PSB0eXBlb2Ygdm5vZGVOYW1lKSByZXR1cm4gYnVpbGRDb21wb25lbnRGcm9tVk5vZGUoZG9tLCB2bm9kZSwgY29udGV4dCwgbW91bnRBbGwpOwogICAgICAgIGlzU3ZnTW9kZSA9ICdzdmcnID09PSB2bm9kZU5hbWUgPyAhMCA6ICdmb3JlaWduT2JqZWN0JyA9PT0gdm5vZGVOYW1lID8gITEgOiBpc1N2Z01vZGU7CiAgICAgICAgdm5vZGVOYW1lID0gU3RyaW5nKHZub2RlTmFtZSk7CiAgICAgICAgaWYgKCFkb20gfHwgIWlzTmFtZWROb2RlKGRvbSwgdm5vZGVOYW1lKSkgewogICAgICAgICAgICBvdXQgPSBjcmVhdGVOb2RlKHZub2RlTmFtZSwgaXNTdmdNb2RlKTsKICAgICAgICAgICAgaWYgKGRvbSkgewogICAgICAgICAgICAgICAgd2hpbGUgKGRvbS5maXJzdENoaWxkKSBvdXQuYXBwZW5kQ2hpbGQoZG9tLmZpcnN0Q2hpbGQpOwogICAgICAgICAgICAgICAgaWYgKGRvbS5wYXJlbnROb2RlKSBkb20ucGFyZW50Tm9kZS5yZXBsYWNlQ2hpbGQob3V0LCBkb20pOwogICAgICAgICAgICAgICAgcmVjb2xsZWN0Tm9kZVRyZWUoZG9tLCAhMCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICAgICAgdmFyIGZjID0gb3V0LmZpcnN0Q2hpbGQsIHByb3BzID0gb3V0Ll9fcHJlYWN0YXR0cl8sIHZjaGlsZHJlbiA9IHZub2RlLmNoaWxkcmVuOwogICAgICAgIGlmIChudWxsID09IHByb3BzKSB7CiAgICAgICAgICAgIHByb3BzID0gb3V0Ll9fcHJlYWN0YXR0cl8gPSB7fTsKICAgICAgICAgICAgZm9yICh2YXIgYSA9IG91dC5hdHRyaWJ1dGVzLCBpID0gYS5sZW5ndGg7IGktLTsgKSBwcm9wc1thW2ldLm5hbWVdID0gYVtpXS52YWx1ZTsKICAgICAgICB9CiAgICAgICAgaWYgKCFoeWRyYXRpbmcgJiYgdmNoaWxkcmVuICYmIDEgPT09IHZjaGlsZHJlbi5sZW5ndGggJiYgJ3N0cmluZycgPT0gdHlwZW9mIHZjaGlsZHJlblswXSAmJiBudWxsICE9IGZjICYmIHZvaWQgMCAhPT0gZmMuc3BsaXRUZXh0ICYmIG51bGwgPT0gZmMubmV4dFNpYmxpbmcpIHsKICAgICAgICAgICAgaWYgKGZjLm5vZGVWYWx1ZSAhPSB2Y2hpbGRyZW5bMF0pIGZjLm5vZGVWYWx1ZSA9IHZjaGlsZHJlblswXTsKICAgICAgICB9IGVsc2UgaWYgKHZjaGlsZHJlbiAmJiB2Y2hpbGRyZW4ubGVuZ3RoIHx8IG51bGwgIT0gZmMpIGlubmVyRGlmZk5vZGUob3V0LCB2Y2hpbGRyZW4sIGNvbnRleHQsIG1vdW50QWxsLCBoeWRyYXRpbmcgfHwgbnVsbCAhPSBwcm9wcy5kYW5nZXJvdXNseVNldElubmVySFRNTCk7CiAgICAgICAgZGlmZkF0dHJpYnV0ZXMob3V0LCB2bm9kZS5hdHRyaWJ1dGVzLCBwcm9wcyk7CiAgICAgICAgaXNTdmdNb2RlID0gcHJldlN2Z01vZGU7CiAgICAgICAgcmV0dXJuIG91dDsKICAgIH0KICAgIGZ1bmN0aW9uIGlubmVyRGlmZk5vZGUoZG9tLCB2Y2hpbGRyZW4sIGNvbnRleHQsIG1vdW50QWxsLCBpc0h5ZHJhdGluZykgewogICAgICAgIHZhciBqLCBjLCBmLCB2Y2hpbGQsIGNoaWxkLCBvcmlnaW5hbENoaWxkcmVuID0gZG9tLmNoaWxkTm9kZXMsIGNoaWxkcmVuID0gW10sIGtleWVkID0ge30sIGtleWVkTGVuID0gMCwgbWluID0gMCwgbGVuID0gb3JpZ2luYWxDaGlsZHJlbi5sZW5ndGgsIGNoaWxkcmVuTGVuID0gMCwgdmxlbiA9IHZjaGlsZHJlbiA/IHZjaGlsZHJlbi5sZW5ndGggOiAwOwogICAgICAgIGlmICgwICE9PSBsZW4pIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsKICAgICAgICAgICAgdmFyIF9jaGlsZCA9IG9yaWdpbmFsQ2hpbGRyZW5baV0sIHByb3BzID0gX2NoaWxkLl9fcHJlYWN0YXR0cl8sIGtleSA9IHZsZW4gJiYgcHJvcHMgPyBfY2hpbGQuX2NvbXBvbmVudCA/IF9jaGlsZC5fY29tcG9uZW50Ll9fayA6IHByb3BzLmtleSA6IG51bGw7CiAgICAgICAgICAgIGlmIChudWxsICE9IGtleSkgewogICAgICAgICAgICAgICAga2V5ZWRMZW4rKzsKICAgICAgICAgICAgICAgIGtleWVkW2tleV0gPSBfY2hpbGQ7CiAgICAgICAgICAgIH0gZWxzZSBpZiAocHJvcHMgfHwgKHZvaWQgMCAhPT0gX2NoaWxkLnNwbGl0VGV4dCA/IGlzSHlkcmF0aW5nID8gX2NoaWxkLm5vZGVWYWx1ZS50cmltKCkgOiAhMCA6IGlzSHlkcmF0aW5nKSkgY2hpbGRyZW5bY2hpbGRyZW5MZW4rK10gPSBfY2hpbGQ7CiAgICAgICAgfQogICAgICAgIGlmICgwICE9PSB2bGVuKSBmb3IgKHZhciBpID0gMDsgaSA8IHZsZW47IGkrKykgewogICAgICAgICAgICB2Y2hpbGQgPSB2Y2hpbGRyZW5baV07CiAgICAgICAgICAgIGNoaWxkID0gbnVsbDsKICAgICAgICAgICAgdmFyIGtleSA9IHZjaGlsZC5rZXk7CiAgICAgICAgICAgIGlmIChudWxsICE9IGtleSkgewogICAgICAgICAgICAgICAgaWYgKGtleWVkTGVuICYmIHZvaWQgMCAhPT0ga2V5ZWRba2V5XSkgewogICAgICAgICAgICAgICAgICAgIGNoaWxkID0ga2V5ZWRba2V5XTsKICAgICAgICAgICAgICAgICAgICBrZXllZFtrZXldID0gdm9pZCAwOwogICAgICAgICAgICAgICAgICAgIGtleWVkTGVuLS07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSBpZiAobWluIDwgY2hpbGRyZW5MZW4pIGZvciAoaiA9IG1pbjsgaiA8IGNoaWxkcmVuTGVuOyBqKyspIGlmICh2b2lkIDAgIT09IGNoaWxkcmVuW2pdICYmIGlzU2FtZU5vZGVUeXBlKGMgPSBjaGlsZHJlbltqXSwgdmNoaWxkLCBpc0h5ZHJhdGluZykpIHsKICAgICAgICAgICAgICAgIGNoaWxkID0gYzsKICAgICAgICAgICAgICAgIGNoaWxkcmVuW2pdID0gdm9pZCAwOwogICAgICAgICAgICAgICAgaWYgKGogPT09IGNoaWxkcmVuTGVuIC0gMSkgY2hpbGRyZW5MZW4tLTsKICAgICAgICAgICAgICAgIGlmIChqID09PSBtaW4pIG1pbisrOwogICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgY2hpbGQgPSBpZGlmZihjaGlsZCwgdmNoaWxkLCBjb250ZXh0LCBtb3VudEFsbCk7CiAgICAgICAgICAgIGYgPSBvcmlnaW5hbENoaWxkcmVuW2ldOwogICAgICAgICAgICBpZiAoY2hpbGQgJiYgY2hpbGQgIT09IGRvbSAmJiBjaGlsZCAhPT0gZikgaWYgKG51bGwgPT0gZikgZG9tLmFwcGVuZENoaWxkKGNoaWxkKTsgZWxzZSBpZiAoY2hpbGQgPT09IGYubmV4dFNpYmxpbmcpIHJlbW92ZU5vZGUoZik7IGVsc2UgZG9tLmluc2VydEJlZm9yZShjaGlsZCwgZik7CiAgICAgICAgfQogICAgICAgIGlmIChrZXllZExlbikgZm9yICh2YXIgaSBpbiBrZXllZCkgaWYgKHZvaWQgMCAhPT0ga2V5ZWRbaV0pIHJlY29sbGVjdE5vZGVUcmVlKGtleWVkW2ldLCAhMSk7CiAgICAgICAgd2hpbGUgKG1pbiA8PSBjaGlsZHJlbkxlbikgaWYgKHZvaWQgMCAhPT0gKGNoaWxkID0gY2hpbGRyZW5bY2hpbGRyZW5MZW4tLV0pKSByZWNvbGxlY3ROb2RlVHJlZShjaGlsZCwgITEpOwogICAgfQogICAgZnVuY3Rpb24gcmVjb2xsZWN0Tm9kZVRyZWUobm9kZSwgdW5tb3VudE9ubHkpIHsKICAgICAgICB2YXIgY29tcG9uZW50ID0gbm9kZS5fY29tcG9uZW50OwogICAgICAgIGlmIChjb21wb25lbnQpIHVubW91bnRDb21wb25lbnQoY29tcG9uZW50KTsgZWxzZSB7CiAgICAgICAgICAgIGlmIChudWxsICE9IG5vZGUuX19wcmVhY3RhdHRyXykgYXBwbHlSZWYobm9kZS5fX3ByZWFjdGF0dHJfLnJlZiwgbnVsbCk7CiAgICAgICAgICAgIGlmICghMSA9PT0gdW5tb3VudE9ubHkgfHwgbnVsbCA9PSBub2RlLl9fcHJlYWN0YXR0cl8pIHJlbW92ZU5vZGUobm9kZSk7CiAgICAgICAgICAgIHJlbW92ZUNoaWxkcmVuKG5vZGUpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJlbW92ZUNoaWxkcmVuKG5vZGUpIHsKICAgICAgICBub2RlID0gbm9kZS5sYXN0Q2hpbGQ7CiAgICAgICAgd2hpbGUgKG5vZGUpIHsKICAgICAgICAgICAgdmFyIG5leHQgPSBub2RlLnByZXZpb3VzU2libGluZzsKICAgICAgICAgICAgcmVjb2xsZWN0Tm9kZVRyZWUobm9kZSwgITApOwogICAgICAgICAgICBub2RlID0gbmV4dDsKICAgICAgICB9CiAgICB9CiAgICBmdW5jdGlvbiBkaWZmQXR0cmlidXRlcyhkb20sIGF0dHJzLCBvbGQpIHsKICAgICAgICB2YXIgbmFtZTsKICAgICAgICBmb3IgKG5hbWUgaW4gb2xkKSBpZiAoKCFhdHRycyB8fCBudWxsID09IGF0dHJzW25hbWVdKSAmJiBudWxsICE9IG9sZFtuYW1lXSkgc2V0QWNjZXNzb3IoZG9tLCBuYW1lLCBvbGRbbmFtZV0sIG9sZFtuYW1lXSA9IHZvaWQgMCwgaXNTdmdNb2RlKTsKICAgICAgICBmb3IgKG5hbWUgaW4gYXR0cnMpIGlmICghKCdjaGlsZHJlbicgPT09IG5hbWUgfHwgJ2lubmVySFRNTCcgPT09IG5hbWUgfHwgbmFtZSBpbiBvbGQgJiYgYXR0cnNbbmFtZV0gPT09ICgndmFsdWUnID09PSBuYW1lIHx8ICdjaGVja2VkJyA9PT0gbmFtZSA/IGRvbVtuYW1lXSA6IG9sZFtuYW1lXSkpKSBzZXRBY2Nlc3Nvcihkb20sIG5hbWUsIG9sZFtuYW1lXSwgb2xkW25hbWVdID0gYXR0cnNbbmFtZV0sIGlzU3ZnTW9kZSk7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVDb21wb25lbnQoQ3RvciwgcHJvcHMsIGNvbnRleHQpIHsKICAgICAgICB2YXIgaW5zdCwgaSA9IHJlY3ljbGVyQ29tcG9uZW50cy5sZW5ndGg7CiAgICAgICAgaWYgKEN0b3IucHJvdG90eXBlICYmIEN0b3IucHJvdG90eXBlLnJlbmRlcikgewogICAgICAgICAgICBpbnN0ID0gbmV3IEN0b3IocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICBDb21wb25lbnQuY2FsbChpbnN0LCBwcm9wcywgY29udGV4dCk7CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgaW5zdCA9IG5ldyBDb21wb25lbnQocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICBpbnN0LmNvbnN0cnVjdG9yID0gQ3RvcjsKICAgICAgICAgICAgaW5zdC5yZW5kZXIgPSBkb1JlbmRlcjsKICAgICAgICB9CiAgICAgICAgd2hpbGUgKGktLSkgaWYgKHJlY3ljbGVyQ29tcG9uZW50c1tpXS5jb25zdHJ1Y3RvciA9PT0gQ3RvcikgewogICAgICAgICAgICBpbnN0Ll9fYiA9IHJlY3ljbGVyQ29tcG9uZW50c1tpXS5fX2I7CiAgICAgICAgICAgIHJlY3ljbGVyQ29tcG9uZW50cy5zcGxpY2UoaSwgMSk7CiAgICAgICAgICAgIHJldHVybiBpbnN0OwogICAgICAgIH0KICAgICAgICByZXR1cm4gaW5zdDsKICAgIH0KICAgIGZ1bmN0aW9uIGRvUmVuZGVyKHByb3BzLCBzdGF0ZSwgY29udGV4dCkgewogICAgICAgIHJldHVybiB0aGlzLmNvbnN0cnVjdG9yKHByb3BzLCBjb250ZXh0KTsKICAgIH0KICAgIGZ1bmN0aW9uIHNldENvbXBvbmVudFByb3BzKGNvbXBvbmVudCwgcHJvcHMsIHJlbmRlck1vZGUsIGNvbnRleHQsIG1vdW50QWxsKSB7CiAgICAgICAgaWYgKCFjb21wb25lbnQuX194KSB7CiAgICAgICAgICAgIGNvbXBvbmVudC5fX3ggPSAhMDsKICAgICAgICAgICAgY29tcG9uZW50Ll9fciA9IHByb3BzLnJlZjsKICAgICAgICAgICAgY29tcG9uZW50Ll9fayA9IHByb3BzLmtleTsKICAgICAgICAgICAgZGVsZXRlIHByb3BzLnJlZjsKICAgICAgICAgICAgZGVsZXRlIHByb3BzLmtleTsKICAgICAgICAgICAgaWYgKHZvaWQgMCA9PT0gY29tcG9uZW50LmNvbnN0cnVjdG9yLmdldERlcml2ZWRTdGF0ZUZyb21Qcm9wcykgaWYgKCFjb21wb25lbnQuYmFzZSB8fCBtb3VudEFsbCkgewogICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5jb21wb25lbnRXaWxsTW91bnQpIGNvbXBvbmVudC5jb21wb25lbnRXaWxsTW91bnQoKTsKICAgICAgICAgICAgfSBlbHNlIGlmIChjb21wb25lbnQuY29tcG9uZW50V2lsbFJlY2VpdmVQcm9wcykgY29tcG9uZW50LmNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMocHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICBpZiAoY29udGV4dCAmJiBjb250ZXh0ICE9PSBjb21wb25lbnQuY29udGV4dCkgewogICAgICAgICAgICAgICAgaWYgKCFjb21wb25lbnQuX19jKSBjb21wb25lbnQuX19jID0gY29tcG9uZW50LmNvbnRleHQ7CiAgICAgICAgICAgICAgICBjb21wb25lbnQuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFjb21wb25lbnQuX19wKSBjb21wb25lbnQuX19wID0gY29tcG9uZW50LnByb3BzOwogICAgICAgICAgICBjb21wb25lbnQucHJvcHMgPSBwcm9wczsKICAgICAgICAgICAgY29tcG9uZW50Ll9feCA9ICExOwogICAgICAgICAgICBpZiAoMCAhPT0gcmVuZGVyTW9kZSkgaWYgKDEgPT09IHJlbmRlck1vZGUgfHwgITEgIT09IG9wdGlvbnMuc3luY0NvbXBvbmVudFVwZGF0ZXMgfHwgIWNvbXBvbmVudC5iYXNlKSByZW5kZXJDb21wb25lbnQoY29tcG9uZW50LCAxLCBtb3VudEFsbCk7IGVsc2UgZW5xdWV1ZVJlbmRlcihjb21wb25lbnQpOwogICAgICAgICAgICBhcHBseVJlZihjb21wb25lbnQuX19yLCBjb21wb25lbnQpOwogICAgICAgIH0KICAgIH0KICAgIGZ1bmN0aW9uIHJlbmRlckNvbXBvbmVudChjb21wb25lbnQsIHJlbmRlck1vZGUsIG1vdW50QWxsLCBpc0NoaWxkKSB7CiAgICAgICAgaWYgKCFjb21wb25lbnQuX194KSB7CiAgICAgICAgICAgIHZhciByZW5kZXJlZCwgaW5zdCwgY2Jhc2UsIHByb3BzID0gY29tcG9uZW50LnByb3BzLCBzdGF0ZSA9IGNvbXBvbmVudC5zdGF0ZSwgY29udGV4dCA9IGNvbXBvbmVudC5jb250ZXh0LCBwcmV2aW91c1Byb3BzID0gY29tcG9uZW50Ll9fcCB8fCBwcm9wcywgcHJldmlvdXNTdGF0ZSA9IGNvbXBvbmVudC5fX3MgfHwgc3RhdGUsIHByZXZpb3VzQ29udGV4dCA9IGNvbXBvbmVudC5fX2MgfHwgY29udGV4dCwgaXNVcGRhdGUgPSBjb21wb25lbnQuYmFzZSwgbmV4dEJhc2UgPSBjb21wb25lbnQuX19iLCBpbml0aWFsQmFzZSA9IGlzVXBkYXRlIHx8IG5leHRCYXNlLCBpbml0aWFsQ2hpbGRDb21wb25lbnQgPSBjb21wb25lbnQuX2NvbXBvbmVudCwgc2tpcCA9ICExLCBzbmFwc2hvdCA9IHByZXZpb3VzQ29udGV4dDsKICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5jb25zdHJ1Y3Rvci5nZXREZXJpdmVkU3RhdGVGcm9tUHJvcHMpIHsKICAgICAgICAgICAgICAgIHN0YXRlID0gZXh0ZW5kKGV4dGVuZCh7fSwgc3RhdGUpLCBjb21wb25lbnQuY29uc3RydWN0b3IuZ2V0RGVyaXZlZFN0YXRlRnJvbVByb3BzKHByb3BzLCBzdGF0ZSkpOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnN0YXRlID0gc3RhdGU7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKGlzVXBkYXRlKSB7CiAgICAgICAgICAgICAgICBjb21wb25lbnQucHJvcHMgPSBwcmV2aW91c1Byb3BzOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnN0YXRlID0gcHJldmlvdXNTdGF0ZTsKICAgICAgICAgICAgICAgIGNvbXBvbmVudC5jb250ZXh0ID0gcHJldmlvdXNDb250ZXh0OwogICAgICAgICAgICAgICAgaWYgKDIgIT09IHJlbmRlck1vZGUgJiYgY29tcG9uZW50LnNob3VsZENvbXBvbmVudFVwZGF0ZSAmJiAhMSA9PT0gY29tcG9uZW50LnNob3VsZENvbXBvbmVudFVwZGF0ZShwcm9wcywgc3RhdGUsIGNvbnRleHQpKSBza2lwID0gITA7IGVsc2UgaWYgKGNvbXBvbmVudC5jb21wb25lbnRXaWxsVXBkYXRlKSBjb21wb25lbnQuY29tcG9uZW50V2lsbFVwZGF0ZShwcm9wcywgc3RhdGUsIGNvbnRleHQpOwogICAgICAgICAgICAgICAgY29tcG9uZW50LnByb3BzID0gcHJvcHM7CiAgICAgICAgICAgICAgICBjb21wb25lbnQuc3RhdGUgPSBzdGF0ZTsKICAgICAgICAgICAgICAgIGNvbXBvbmVudC5jb250ZXh0ID0gY29udGV4dDsKICAgICAgICAgICAgfQogICAgICAgICAgICBjb21wb25lbnQuX19wID0gY29tcG9uZW50Ll9fcyA9IGNvbXBvbmVudC5fX2MgPSBjb21wb25lbnQuX19iID0gbnVsbDsKICAgICAgICAgICAgY29tcG9uZW50Ll9fZCA9ICExOwogICAgICAgICAgICBpZiAoIXNraXApIHsKICAgICAgICAgICAgICAgIHJlbmRlcmVkID0gY29tcG9uZW50LnJlbmRlcihwcm9wcywgc3RhdGUsIGNvbnRleHQpOwogICAgICAgICAgICAgICAgaWYgKGNvbXBvbmVudC5nZXRDaGlsZENvbnRleHQpIGNvbnRleHQgPSBleHRlbmQoZXh0ZW5kKHt9LCBjb250ZXh0KSwgY29tcG9uZW50LmdldENoaWxkQ29udGV4dCgpKTsKICAgICAgICAgICAgICAgIGlmIChpc1VwZGF0ZSAmJiBjb21wb25lbnQuZ2V0U25hcHNob3RCZWZvcmVVcGRhdGUpIHNuYXBzaG90ID0gY29tcG9uZW50LmdldFNuYXBzaG90QmVmb3JlVXBkYXRlKHByZXZpb3VzUHJvcHMsIHByZXZpb3VzU3RhdGUpOwogICAgICAgICAgICAgICAgdmFyIHRvVW5tb3VudCwgYmFzZSwgY2hpbGRDb21wb25lbnQgPSByZW5kZXJlZCAmJiByZW5kZXJlZC5ub2RlTmFtZTsKICAgICAgICAgICAgICAgIGlmICgnZnVuY3Rpb24nID09IHR5cGVvZiBjaGlsZENvbXBvbmVudCkgewogICAgICAgICAgICAgICAgICAgIHZhciBjaGlsZFByb3BzID0gZ2V0Tm9kZVByb3BzKHJlbmRlcmVkKTsKICAgICAgICAgICAgICAgICAgICBpbnN0ID0gaW5pdGlhbENoaWxkQ29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgIGlmIChpbnN0ICYmIGluc3QuY29uc3RydWN0b3IgPT09IGNoaWxkQ29tcG9uZW50ICYmIGNoaWxkUHJvcHMua2V5ID09IGluc3QuX19rKSBzZXRDb21wb25lbnRQcm9wcyhpbnN0LCBjaGlsZFByb3BzLCAxLCBjb250ZXh0LCAhMSk7IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICB0b1VubW91bnQgPSBpbnN0OwogICAgICAgICAgICAgICAgICAgICAgICBjb21wb25lbnQuX2NvbXBvbmVudCA9IGluc3QgPSBjcmVhdGVDb21wb25lbnQoY2hpbGRDb21wb25lbnQsIGNoaWxkUHJvcHMsIGNvbnRleHQpOwogICAgICAgICAgICAgICAgICAgICAgICBpbnN0Ll9fYiA9IGluc3QuX19iIHx8IG5leHRCYXNlOwogICAgICAgICAgICAgICAgICAgICAgICBpbnN0Ll9fdSA9IGNvbXBvbmVudDsKICAgICAgICAgICAgICAgICAgICAgICAgc2V0Q29tcG9uZW50UHJvcHMoaW5zdCwgY2hpbGRQcm9wcywgMCwgY29udGV4dCwgITEpOwogICAgICAgICAgICAgICAgICAgICAgICByZW5kZXJDb21wb25lbnQoaW5zdCwgMSwgbW91bnRBbGwsICEwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgYmFzZSA9IGluc3QuYmFzZTsKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgY2Jhc2UgPSBpbml0aWFsQmFzZTsKICAgICAgICAgICAgICAgICAgICB0b1VubW91bnQgPSBpbml0aWFsQ2hpbGRDb21wb25lbnQ7CiAgICAgICAgICAgICAgICAgICAgaWYgKHRvVW5tb3VudCkgY2Jhc2UgPSBjb21wb25lbnQuX2NvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgaWYgKGluaXRpYWxCYXNlIHx8IDEgPT09IHJlbmRlck1vZGUpIHsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKGNiYXNlKSBjYmFzZS5fY29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZSA9IGRpZmYoY2Jhc2UsIHJlbmRlcmVkLCBjb250ZXh0LCBtb3VudEFsbCB8fCAhaXNVcGRhdGUsIGluaXRpYWxCYXNlICYmIGluaXRpYWxCYXNlLnBhcmVudE5vZGUsICEwKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAoaW5pdGlhbEJhc2UgJiYgYmFzZSAhPT0gaW5pdGlhbEJhc2UgJiYgaW5zdCAhPT0gaW5pdGlhbENoaWxkQ29tcG9uZW50KSB7CiAgICAgICAgICAgICAgICAgICAgdmFyIGJhc2VQYXJlbnQgPSBpbml0aWFsQmFzZS5wYXJlbnROb2RlOwogICAgICAgICAgICAgICAgICAgIGlmIChiYXNlUGFyZW50ICYmIGJhc2UgIT09IGJhc2VQYXJlbnQpIHsKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZVBhcmVudC5yZXBsYWNlQ2hpbGQoYmFzZSwgaW5pdGlhbEJhc2UpOwogICAgICAgICAgICAgICAgICAgICAgICBpZiAoIXRvVW5tb3VudCkgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgaW5pdGlhbEJhc2UuX2NvbXBvbmVudCA9IG51bGw7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICByZWNvbGxlY3ROb2RlVHJlZShpbml0aWFsQmFzZSwgITEpOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgaWYgKHRvVW5tb3VudCkgdW5tb3VudENvbXBvbmVudCh0b1VubW91bnQpOwogICAgICAgICAgICAgICAgY29tcG9uZW50LmJhc2UgPSBiYXNlOwogICAgICAgICAgICAgICAgaWYgKGJhc2UgJiYgIWlzQ2hpbGQpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgY29tcG9uZW50UmVmID0gY29tcG9uZW50LCB0ID0gY29tcG9uZW50OwogICAgICAgICAgICAgICAgICAgIHdoaWxlICh0ID0gdC5fX3UpIChjb21wb25lbnRSZWYgPSB0KS5iYXNlID0gYmFzZTsKICAgICAgICAgICAgICAgICAgICBiYXNlLl9jb21wb25lbnQgPSBjb21wb25lbnRSZWY7CiAgICAgICAgICAgICAgICAgICAgYmFzZS5fY29tcG9uZW50Q29uc3RydWN0b3IgPSBjb21wb25lbnRSZWYuY29uc3RydWN0b3I7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgaWYgKCFpc1VwZGF0ZSB8fCBtb3VudEFsbCkgbW91bnRzLnB1c2goY29tcG9uZW50KTsgZWxzZSBpZiAoIXNraXApIHsKICAgICAgICAgICAgICAgIGlmIChjb21wb25lbnQuY29tcG9uZW50RGlkVXBkYXRlKSBjb21wb25lbnQuY29tcG9uZW50RGlkVXBkYXRlKHByZXZpb3VzUHJvcHMsIHByZXZpb3VzU3RhdGUsIHNuYXBzaG90KTsKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zLmFmdGVyVXBkYXRlKSBvcHRpb25zLmFmdGVyVXBkYXRlKGNvbXBvbmVudCk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgd2hpbGUgKGNvbXBvbmVudC5fX2gubGVuZ3RoKSBjb21wb25lbnQuX19oLnBvcCgpLmNhbGwoY29tcG9uZW50KTsKICAgICAgICAgICAgaWYgKCFkaWZmTGV2ZWwgJiYgIWlzQ2hpbGQpIGZsdXNoTW91bnRzKCk7CiAgICAgICAgfQogICAgfQogICAgZnVuY3Rpb24gYnVpbGRDb21wb25lbnRGcm9tVk5vZGUoZG9tLCB2bm9kZSwgY29udGV4dCwgbW91bnRBbGwpIHsKICAgICAgICB2YXIgYyA9IGRvbSAmJiBkb20uX2NvbXBvbmVudCwgb3JpZ2luYWxDb21wb25lbnQgPSBjLCBvbGREb20gPSBkb20sIGlzRGlyZWN0T3duZXIgPSBjICYmIGRvbS5fY29tcG9uZW50Q29uc3RydWN0b3IgPT09IHZub2RlLm5vZGVOYW1lLCBpc093bmVyID0gaXNEaXJlY3RPd25lciwgcHJvcHMgPSBnZXROb2RlUHJvcHModm5vZGUpOwogICAgICAgIHdoaWxlIChjICYmICFpc093bmVyICYmIChjID0gYy5fX3UpKSBpc093bmVyID0gYy5jb25zdHJ1Y3RvciA9PT0gdm5vZGUubm9kZU5hbWU7CiAgICAgICAgaWYgKGMgJiYgaXNPd25lciAmJiAoIW1vdW50QWxsIHx8IGMuX2NvbXBvbmVudCkpIHsKICAgICAgICAgICAgc2V0Q29tcG9uZW50UHJvcHMoYywgcHJvcHMsIDMsIGNvbnRleHQsIG1vdW50QWxsKTsKICAgICAgICAgICAgZG9tID0gYy5iYXNlOwogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGlmIChvcmlnaW5hbENvbXBvbmVudCAmJiAhaXNEaXJlY3RPd25lcikgewogICAgICAgICAgICAgICAgdW5tb3VudENvbXBvbmVudChvcmlnaW5hbENvbXBvbmVudCk7CiAgICAgICAgICAgICAgICBkb20gPSBvbGREb20gPSBudWxsOwogICAgICAgICAgICB9CiAgICAgICAgICAgIGMgPSBjcmVhdGVDb21wb25lbnQodm5vZGUubm9kZU5hbWUsIHByb3BzLCBjb250ZXh0KTsKICAgICAgICAgICAgaWYgKGRvbSAmJiAhYy5fX2IpIHsKICAgICAgICAgICAgICAgIGMuX19iID0gZG9tOwogICAgICAgICAgICAgICAgb2xkRG9tID0gbnVsbDsKICAgICAgICAgICAgfQogICAgICAgICAgICBzZXRDb21wb25lbnRQcm9wcyhjLCBwcm9wcywgMSwgY29udGV4dCwgbW91bnRBbGwpOwogICAgICAgICAgICBkb20gPSBjLmJhc2U7CiAgICAgICAgICAgIGlmIChvbGREb20gJiYgZG9tICE9PSBvbGREb20pIHsKICAgICAgICAgICAgICAgIG9sZERvbS5fY29tcG9uZW50ID0gbnVsbDsKICAgICAgICAgICAgICAgIHJlY29sbGVjdE5vZGVUcmVlKG9sZERvbSwgITEpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIHJldHVybiBkb207CiAgICB9CiAgICBmdW5jdGlvbiB1bm1vdW50Q29tcG9uZW50KGNvbXBvbmVudCkgewogICAgICAgIGlmIChvcHRpb25zLmJlZm9yZVVubW91bnQpIG9wdGlvbnMuYmVmb3JlVW5tb3VudChjb21wb25lbnQpOwogICAgICAgIHZhciBiYXNlID0gY29tcG9uZW50LmJhc2U7CiAgICAgICAgY29tcG9uZW50Ll9feCA9ICEwOwogICAgICAgIGlmIChjb21wb25lbnQuY29tcG9uZW50V2lsbFVubW91bnQpIGNvbXBvbmVudC5jb21wb25lbnRXaWxsVW5tb3VudCgpOwogICAgICAgIGNvbXBvbmVudC5iYXNlID0gbnVsbDsKICAgICAgICB2YXIgaW5uZXIgPSBjb21wb25lbnQuX2NvbXBvbmVudDsKICAgICAgICBpZiAoaW5uZXIpIHVubW91bnRDb21wb25lbnQoaW5uZXIpOyBlbHNlIGlmIChiYXNlKSB7CiAgICAgICAgICAgIGlmIChudWxsICE9IGJhc2UuX19wcmVhY3RhdHRyXykgYXBwbHlSZWYoYmFzZS5fX3ByZWFjdGF0dHJfLnJlZiwgbnVsbCk7CiAgICAgICAgICAgIGNvbXBvbmVudC5fX2IgPSBiYXNlOwogICAgICAgICAgICByZW1vdmVOb2RlKGJhc2UpOwogICAgICAgICAgICByZWN5Y2xlckNvbXBvbmVudHMucHVzaChjb21wb25lbnQpOwogICAgICAgICAgICByZW1vdmVDaGlsZHJlbihiYXNlKTsKICAgICAgICB9CiAgICAgICAgYXBwbHlSZWYoY29tcG9uZW50Ll9fciwgbnVsbCk7CiAgICB9CiAgICBmdW5jdGlvbiBDb21wb25lbnQocHJvcHMsIGNvbnRleHQpIHsKICAgICAgICB0aGlzLl9fZCA9ICEwOwogICAgICAgIHRoaXMuY29udGV4dCA9IGNvbnRleHQ7CiAgICAgICAgdGhpcy5wcm9wcyA9IHByb3BzOwogICAgICAgIHRoaXMuc3RhdGUgPSB0aGlzLnN0YXRlIHx8IHt9OwogICAgICAgIHRoaXMuX19oID0gW107CiAgICB9CiAgICBmdW5jdGlvbiByZW5kZXIodm5vZGUsIHBhcmVudCwgbWVyZ2UpIHsKICAgICAgICByZXR1cm4gZGlmZihtZXJnZSwgdm5vZGUsIHt9LCAhMSwgcGFyZW50LCAhMSk7CiAgICB9CiAgICBmdW5jdGlvbiBjcmVhdGVSZWYoKSB7CiAgICAgICAgcmV0dXJuIHt9OwogICAgfQogICAgdmFyIFZOb2RlID0gZnVuY3Rpb24oKSB7fTsKICAgIHZhciBvcHRpb25zID0ge307CiAgICB2YXIgc3RhY2sgPSBbXTsKICAgIHZhciBFTVBUWV9DSElMRFJFTiA9IFtdOwogICAgdmFyIGRlZmVyID0gJ2Z1bmN0aW9uJyA9PSB0eXBlb2YgUHJvbWlzZSA/IFByb21pc2UucmVzb2x2ZSgpLnRoZW4uYmluZChQcm9taXNlLnJlc29sdmUoKSkgOiBzZXRUaW1lb3V0OwogICAgdmFyIElTX05PTl9ESU1FTlNJT05BTCA9IC9hY2l0fGV4KD86c3xnfG58cHwkKXxycGh8b3dzfG1uY3xudHd8aW5lW2NoXXx6b298Xm9yZC9pOwogICAgdmFyIGl0ZW1zID0gW107CiAgICB2YXIgbW91bnRzID0gW107CiAgICB2YXIgZGlmZkxldmVsID0gMDsKICAgIHZhciBpc1N2Z01vZGUgPSAhMTsKICAgIHZhciBoeWRyYXRpbmcgPSAhMTsKICAgIHZhciByZWN5Y2xlckNvbXBvbmVudHMgPSBbXTsKICAgIGV4dGVuZChDb21wb25lbnQucHJvdG90eXBlLCB7CiAgICAgICAgc2V0U3RhdGU6IGZ1bmN0aW9uKHN0YXRlLCBjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoIXRoaXMuX19zKSB0aGlzLl9fcyA9IHRoaXMuc3RhdGU7CiAgICAgICAgICAgIHRoaXMuc3RhdGUgPSBleHRlbmQoZXh0ZW5kKHt9LCB0aGlzLnN0YXRlKSwgJ2Z1bmN0aW9uJyA9PSB0eXBlb2Ygc3RhdGUgPyBzdGF0ZSh0aGlzLnN0YXRlLCB0aGlzLnByb3BzKSA6IHN0YXRlKTsKICAgICAgICAgICAgaWYgKGNhbGxiYWNrKSB0aGlzLl9faC5wdXNoKGNhbGxiYWNrKTsKICAgICAgICAgICAgZW5xdWV1ZVJlbmRlcih0aGlzKTsKICAgICAgICB9LAogICAgICAgIGZvcmNlVXBkYXRlOiBmdW5jdGlvbihjYWxsYmFjaykgewogICAgICAgICAgICBpZiAoY2FsbGJhY2spIHRoaXMuX19oLnB1c2goY2FsbGJhY2spOwogICAgICAgICAgICByZW5kZXJDb21wb25lbnQodGhpcywgMik7CiAgICAgICAgfSwKICAgICAgICByZW5kZXI6IGZ1bmN0aW9uKCkge30KICAgIH0pOwogICAgdmFyIHByZWFjdCA9IHsKICAgICAgICBoOiBoLAogICAgICAgIGNyZWF0ZUVsZW1lbnQ6IGgsCiAgICAgICAgY2xvbmVFbGVtZW50OiBjbG9uZUVsZW1lbnQsCiAgICAgICAgY3JlYXRlUmVmOiBjcmVhdGVSZWYsCiAgICAgICAgQ29tcG9uZW50OiBDb21wb25lbnQsCiAgICAgICAgcmVuZGVyOiByZW5kZXIsCiAgICAgICAgcmVyZW5kZXI6IHJlcmVuZGVyLAogICAgICAgIG9wdGlvbnM6IG9wdGlvbnMKICAgIH07CiAgICBpZiAoJ3VuZGVmaW5lZCcgIT0gdHlwZW9mIG1vZHVsZSkgbW9kdWxlLmV4cG9ydHMgPSBwcmVhY3Q7IGVsc2Ugc2VsZi5wcmVhY3QgPSBwcmVhY3Q7Cn0oKTsKCn0se31dLDI6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Cgp2YXIgX3R5cGVvZiA9IHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgdHlwZW9mIFN5bWJvbC5pdGVyYXRvciA9PT0gInN5bWJvbCIgPyBmdW5jdGlvbiAob2JqKSB7IHJldHVybiB0eXBlb2Ygb2JqOyB9IDogZnVuY3Rpb24gKG9iaikgeyByZXR1cm4gb2JqICYmIHR5cGVvZiBTeW1ib2wgPT09ICJmdW5jdGlvbiIgJiYgb2JqLmNvbnN0cnVjdG9yID09PSBTeW1ib2wgJiYgb2JqICE9PSBTeW1ib2wucHJvdG90eXBlID8gInN5bWJvbCIgOiB0eXBlb2Ygb2JqOyB9OwoKdmFyIF9jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KCk7CgpmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0KCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7Cgp2YXIgQ29va2llID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gQ29va2llKCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBDb29raWUpOwogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhDb29raWUsIG51bGwsIFt7CiAgICAgICAga2V5OiAiZ2V0QWxsIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gZ2V0QWxsKCkgewogICAgICAgICAgICB2YXIgY29va2llcyA9IHt9OwogICAgICAgICAgICBkb2N1bWVudC5jb29raWUuc3BsaXQoIjsiKS5mb3JFYWNoKGZ1bmN0aW9uIChjb29raWUpIHsKICAgICAgICAgICAgICAgIHZhciBwYXJ0cyA9IGNvb2tpZS50cmltKCkuc3BsaXQoIj0iKTsKICAgICAgICAgICAgICAgIHZhciBuYW1lID0gcGFydHNbMF07CiAgICAgICAgICAgICAgICB2YXIgdmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQocGFydHNbMV0pOwogICAgICAgICAgICAgICAgY29va2llc1tuYW1lXSA9IHZhbHVlOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgcmV0dXJuIGNvb2tpZXM7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogImdldCIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldChuYW1lKSB7CiAgICAgICAgICAgIHZhciBjb29raWVzID0gQ29va2llLmdldEFsbCgpOwogICAgICAgICAgICB2YXIgdmFsdWUgPSBjb29raWVzW25hbWVdOwogICAgICAgICAgICBpZiAodHlwZW9mIHZhbHVlID09PSAidW5kZWZpbmVkIikgewogICAgICAgICAgICAgICAgcmV0dXJuICIiOwogICAgICAgICAgICB9CiAgICAgICAgICAgIHJldHVybiB2YWx1ZTsKICAgICAgICB9CiAgICB9LCB7CiAgICAgICAga2V5OiAic2V0IiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0KG5hbWUsIHZhbHVlKSB7CiAgICAgICAgICAgIHZhciBvcHRpb25zID0gYXJndW1lbnRzLmxlbmd0aCA+IDIgJiYgYXJndW1lbnRzWzJdICE9PSB1bmRlZmluZWQgPyBhcmd1bWVudHNbMl0gOiB7fTsKCiAgICAgICAgICAgIHZhciBlbmNvZGVkVmFsdWUgPSBkZWNvZGVVUklDb21wb25lbnQoU3RyaW5nKHZhbHVlKSk7CiAgICAgICAgICAgIHZhciBjb29raWVTdHJpbmcgPSBuYW1lICsgIj0iICsgZW5jb2RlZFZhbHVlOwogICAgICAgICAgICAvLyBmb3JFYWNoIG9wdGlvbnMKICAgICAgICAgICAgZm9yICh2YXIgayBpbiBvcHRpb25zKSB7CiAgICAgICAgICAgICAgICB2YXIgb3B0VmFsdWUgPSAiIjsKICAgICAgICAgICAgICAgIHZhciBvcHRUeXBlID0gX3R5cGVvZihvcHRpb25zW2tdKTsKICAgICAgICAgICAgICAgIC8vIFRPRE86IGNvbnZlcnQgYERhdGVgIG9iamVjdCB0byBzdHJpbmcKICAgICAgICAgICAgICAgIGlmIChvcHRpb25zW2tdIGluc3RhbmNlb2YgRGF0ZSkgewogICAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcigiTm90IEltcGxlbWVudGVkIik7CiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKG9wdFR5cGUgPT09ICJzdHJpbmciIHx8IG9wdFR5cGUgPT09ICJudW1iZXIiKSB7CiAgICAgICAgICAgICAgICAgICAgb3B0VmFsdWUgPSBTdHJpbmcob3B0aW9uc1trXSk7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3B0VmFsdWUgIT09ICIiKSB7CiAgICAgICAgICAgICAgICAgICAgY29va2llU3RyaW5nICs9ICI7IiArIGsgKyAiPSIgKyBvcHRWYWx1ZTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBkb2N1bWVudC5jb29raWUgPSBjb29raWVTdHJpbmc7CiAgICAgICAgfQogICAgfV0pOwoKICAgIHJldHVybiBDb29raWU7Cn0oKTsKCmV4cG9ydHMuQ29va2llID0gQ29va2llOwoKfSx7fV0sMzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CmZ1bmN0aW9uIHNheUhlbGxvKG5hbWUpIHsKICAgIHJldHVybiAiSGVsbG8gZnJvbSAiICsgbmFtZTsKfQpleHBvcnRzLnNheUhlbGxvID0gc2F5SGVsbG87Cgp9LHt9XSw0OltmdW5jdGlvbihyZXF1aXJlLG1vZHVsZSxleHBvcnRzKXsKInVzZSBzdHJpY3QiOwoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKZnVuY3Rpb24gZ2V0UGFnZURvbShyZXNvdXJjZSkgewogICAgdmFyIGluaXQgPSB7CiAgICAgICAgY3JlZGVudGlhbHM6ICJzYW1lLW9yaWdpbiIKICAgIH07CiAgICByZXR1cm4gZmV0Y2gocmVzb3VyY2UsIGluaXQpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlKSB7CiAgICAgICAgaWYgKCFyZXNwb25zZS5vaykgewogICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIkhUVFAgZXJyb3IsIHN0YXR1cyA9ICIgKyByZXNwb25zZS5zdGF0dXMpOwogICAgICAgIH0KICAgICAgICByZXR1cm4gcmVzcG9uc2UudGV4dCgpOwogICAgfSkudGhlbihmdW5jdGlvbiAocmVzcG9uc2VUZXh0KSB7CiAgICAgICAgdmFyIHJlc3BvbnNlRG9tID0gbmV3IERPTVBhcnNlcigpLnBhcnNlRnJvbVN0cmluZyhyZXNwb25zZVRleHQsICJ0ZXh0L2h0bWwiKTsKICAgICAgICByZXR1cm4gcmVzcG9uc2VEb207CiAgICB9KTsKfQpleHBvcnRzLmdldFBhZ2VEb20gPSBnZXRQYWdlRG9tOwpmdW5jdGlvbiBpc0luVmlld3BvcnQoZWxlbSkgewogICAgLy8gdGhhbmtzIHtAbGluayBodHRwczovL2dvbWFrZXRoaW5ncy5jb20vaG93LXRvLXRlc3QtaWYtYW4tZWxlbWVudC1pcy1pbi10aGUtdmlld3BvcnQtd2l0aC12YW5pbGxhLWphdmFzY3JpcHQvfQogICAgdmFyIGJvdW5kaW5nID0gZWxlbS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTsKICAgIHJldHVybiBib3VuZGluZy50b3AgPj0gMCAmJiBib3VuZGluZy5sZWZ0ID49IDAgJiYgYm91bmRpbmcuYm90dG9tIDw9ICh3aW5kb3cuaW5uZXJIZWlnaHQgfHwgZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodCkgJiYgYm91bmRpbmcucmlnaHQgPD0gKHdpbmRvdy5pbm5lcldpZHRoIHx8IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCk7Cn0KZXhwb3J0cy5pc0luVmlld3BvcnQgPSBpc0luVmlld3BvcnQ7Ci8vIFJldHVybnMgYSBmdW5jdGlvbiwgdGhhdCwgYXMgbG9uZyBhcyBpdCBjb250aW51ZXMgdG8gYmUgaW52b2tlZCwgd2lsbCBub3QKLy8gYmUgdHJpZ2dlcmVkLiBUaGUgZnVuY3Rpb24gd2lsbCBiZSBjYWxsZWQgYWZ0ZXIgaXQgc3RvcHMgYmVpbmcgY2FsbGVkIGZvcgovLyBOIG1pbGxpc2Vjb25kcy4gSWYgYGltbWVkaWF0ZWAgaXMgcGFzc2VkLCB0cmlnZ2VyIHRoZSBmdW5jdGlvbiBvbiB0aGUKLy8gbGVhZGluZyBlZGdlLCBpbnN0ZWFkIG9mIHRoZSB0cmFpbGluZy4KLy8gdGhhbmtzIHtAbGluayBodHRwczovL2Rhdmlkd2Fsc2gubmFtZS9qYXZhc2NyaXB0LWRlYm91bmNlLWZ1bmN0aW9ufQpmdW5jdGlvbiBkZWJvdW5jZShmdW5jLCB3YWl0LCBpbW1lZGlhdGUpIHsKICAgIHZhciB0aW1lb3V0OwogICAgcmV0dXJuIGZ1bmN0aW9uICgpIHsKICAgICAgICB2YXIgY29udGV4dCA9IHRoaXMsCiAgICAgICAgICAgIGFyZ3MgPSBhcmd1bWVudHM7CiAgICAgICAgdmFyIGxhdGVyID0gZnVuY3Rpb24gbGF0ZXIoKSB7CiAgICAgICAgICAgIHRpbWVvdXQgPSBudWxsOwogICAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkgZnVuYy5hcHBseShjb250ZXh0LCBhcmdzKTsKICAgICAgICB9OwogICAgICAgIHZhciBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0OwogICAgICAgIGNsZWFyVGltZW91dCh0aW1lb3V0KTsKICAgICAgICB0aW1lb3V0ID0gc2V0VGltZW91dChsYXRlciwgd2FpdCk7CiAgICAgICAgaWYgKGNhbGxOb3cpIGZ1bmMuYXBwbHkoY29udGV4dCwgYXJncyk7CiAgICB9Owp9CmV4cG9ydHMuZGVib3VuY2UgPSBkZWJvdW5jZTsKCn0se31dLDU6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0oKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKdmFyIGNvb2tpZV8xID0gcmVxdWlyZSgiLi9jb29raWUiKTsKdmFyIGhlbHBlcnNfMSA9IHJlcXVpcmUoIi4vaGVscGVycyIpOwp2YXIgQ09PS0lFX05BTUUgPSAiSGlnaGxpZ2h0TmV3U2VyaWVzIjsKCnZhciBIaWdobGlnaHROZXdTZXJpZXMgPSBmdW5jdGlvbiAoKSB7CiAgICBfY3JlYXRlQ2xhc3MoSGlnaGxpZ2h0TmV3U2VyaWVzLCBbewogICAgICAgIGtleTogImVuYWJsZWQiLAogICAgICAgIGdldDogZnVuY3Rpb24gZ2V0KCkgewogICAgICAgICAgICByZXR1cm4gY29va2llXzEuQ29va2llLmdldChDT09LSUVfTkFNRSkgPT0gInllcyI7CiAgICAgICAgfSwKICAgICAgICBzZXQ6IGZ1bmN0aW9uIHNldChlbmFibGUpIHsKICAgICAgICAgICAgdmFyIHZhbHVlID0gZW5hYmxlID8gInllcyIgOiAibm8iOwogICAgICAgICAgICBjb29raWVfMS5Db29raWUuc2V0KENPT0tJRV9OQU1FLCB2YWx1ZSwgeyBwYXRoOiAiLyIgfSk7CiAgICAgICAgfQogICAgfV0pOwoKICAgIGZ1bmN0aW9uIEhpZ2hsaWdodE5ld1NlcmllcygpIHsKICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICBfY2xhc3NDYWxsQ2hlY2sodGhpcywgSGlnaGxpZ2h0TmV3U2VyaWVzKTsKCiAgICAgICAgdGhpcy50aHVtYkxpc3QgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIudGh1bWJsaXN0Iik7CiAgICAgICAgdmFyIGNvbnRyb2xTdHJpcEVsbSA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5jb250cm9sc3RyaXAiKTsKICAgICAgICB2YXIgaXNQcm9kdWN0UGFnZSA9IEJvb2xlYW4oY29udHJvbFN0cmlwRWxtKTsKICAgICAgICB2YXIgaXNFbmFibGVkID0gdGhpcy5lbmFibGVkOwogICAgICAgIC8vIFRoaXMgYmluZGluZyBpcyBuZWNlc3NhcnkgdG8gbWFrZSBgdGhpc2Agd29yayBpbiB0aGUgY2FsbGJhY2sKICAgICAgICB0aGlzLnNldHRpbmdDaGFuZ2VkID0gdGhpcy5zZXR0aW5nQ2hhbmdlZC5iaW5kKHRoaXMpOwogICAgICAgIHRoaXMuZGVib3VuY2VRdWVyeU5ld1NlcmllcyA9IGhlbHBlcnNfMS5kZWJvdW5jZSh0aGlzLnF1ZXJ5TmV3U2VyaWVzLmJpbmQodGhpcyksIDI1MCk7CiAgICAgICAgaWYgKGlzUHJvZHVjdFBhZ2UpIHsKICAgICAgICAgICAgLy8gYXBwZW5kIGRvbQogICAgICAgICAgICB2YXIgaW5wdXROYW1lID0gImhpZ2hsaWdodG5ld3NlcmllcyI7CiAgICAgICAgICAgIHZhciB3cmFwcGVyID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgic3BhbiIpOwogICAgICAgICAgICB2YXIgY2hlY2tib3ggPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJpbnB1dCIpOwogICAgICAgICAgICB2YXIgbGFiZWwgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJsYWJlbCIpOwogICAgICAgICAgICB3cmFwcGVyLmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodC1uZXctc2VyaWVzLWNvbnRyb2wiKTsKICAgICAgICAgICAgY2hlY2tib3guc2V0QXR0cmlidXRlKCJpZCIsIGlucHV0TmFtZSk7CiAgICAgICAgICAgIGNoZWNrYm94LnNldEF0dHJpYnV0ZSgibmFtZSIsIGlucHV0TmFtZSk7CiAgICAgICAgICAgIGNoZWNrYm94LnNldEF0dHJpYnV0ZSgidHlwZSIsICJjaGVja2JveCIpOwogICAgICAgICAgICBjaGVja2JveC5zZXRBdHRyaWJ1dGUoInZhbHVlIiwgInllcyIpOwogICAgICAgICAgICBpZiAoaXNFbmFibGVkKSB7CiAgICAgICAgICAgICAgICBjaGVja2JveC5jaGVja2VkID0gdHJ1ZTsKICAgICAgICAgICAgfQogICAgICAgICAgICBjaGVja2JveC5hZGRFdmVudExpc3RlbmVyKCJjaGFuZ2UiLCB0aGlzLnNldHRpbmdDaGFuZ2VkKTsKICAgICAgICAgICAgbGFiZWwuc2V0QXR0cmlidXRlKCJmb3IiLCBpbnB1dE5hbWUpOwogICAgICAgICAgICBsYWJlbC5pbm5lckhUTUwgPSAiU2hvdyBOZXcgIzFzIjsKICAgICAgICAgICAgd3JhcHBlci5hcHBlbmRDaGlsZChsYWJlbCk7CiAgICAgICAgICAgIHdyYXBwZXIuYXBwZW5kQ2hpbGQoY2hlY2tib3gpOwogICAgICAgICAgICBjb250cm9sU3RyaXBFbG0ucXVlcnlTZWxlY3RvcigiLmZsb2F0LXJpZ2h0IikucHJlcGVuZCh3cmFwcGVyKTsKICAgICAgICAgICAgLy8gaW5jYXNlIG5ldyBlbGVtZW50cyBiZWNvbWVzIHZpc2libGUgZHVlIHRvIG90aGVyIGZlYXR1cmVzIChlZy4gSW5maW5pdGUgU2Nyb2xsKQogICAgICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbiAobXV0YXRpb25zTGlzdCwgb2JzZXJ2ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIm11dGF0aW9uIGV2ZW50IFtobnNdIiwgbXV0YXRpb25zTGlzdCwgb2JzZXJ2ZXIpOwogICAgICAgICAgICAgICAgX3RoaXMuZGVib3VuY2VRdWVyeU5ld1NlcmllcygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLnRodW1iTGlzdCwgeyBhdHRyaWJ1dGVzOiBmYWxzZSwgY2hpbGRMaXN0OiB0cnVlLCBzdWJ0cmVlOiB0cnVlIH0pOwogICAgICAgIH0KICAgICAgICBpZiAoaXNQcm9kdWN0UGFnZSAmJiBpc0VuYWJsZWQpIHsKICAgICAgICAgICAgdGhpcy5xdWVyeU5ld1NlcmllcygpOwogICAgICAgIH0KICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoSGlnaGxpZ2h0TmV3U2VyaWVzLCBbewogICAgICAgIGtleTogInNldHRpbmdDaGFuZ2VkIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gc2V0dGluZ0NoYW5nZWQoZXZlbnQpIHsKICAgICAgICAgICAgaWYgKGV2ZW50LnRhcmdldC5jaGVja2VkKSB7CiAgICAgICAgICAgICAgICBjb25zb2xlLmxvZygnY2hlY2tlZCcpOwogICAgICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKICAgICAgICAgICAgICAgIHRoaXMucXVlcnlOZXdTZXJpZXMoKTsKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUubG9nKCdub3QgY2hlY2tlZCcpOwogICAgICAgICAgICAgICAgdGhpcy5lbmFibGVkID0gZmFsc2U7CiAgICAgICAgICAgICAgICB0aGlzLnRodW1iTGlzdC5jbGFzc0xpc3QucmVtb3ZlKCJoaWdobGlnaHQtbmV3LXNlcmllcyIpOwogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogImhpZ2hsaWdodE5ld1NlcmllcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhpZ2hsaWdodE5ld1NlcmllcygpIHsKICAgICAgICAgICAgLy8gVE9ETzogYXBwbHkgdG8gYFRleHRWaWV3YCBhcyB3ZWxsCiAgICAgICAgICAgIHRoaXMudGh1bWJMaXN0LmNsYXNzTGlzdC5hZGQoImhpZ2hsaWdodC1uZXctc2VyaWVzIik7CiAgICAgICAgICAgIHRoaXMudGh1bWJMaXN0LnF1ZXJ5U2VsZWN0b3JBbGwoImxpOm5vdCgubmV3LXNlcmllcyk6bm90KC5leGlzdGluZy1zZXJpZXMpIikuZm9yRWFjaChmdW5jdGlvbiAoaXRlbSkgewogICAgICAgICAgICAgICAgdmFyIGNvbWljVGl0bGUgPSBpdGVtLnF1ZXJ5U2VsZWN0b3IoIi5kZXRhaWwgaDUiKS50ZXh0Q29udGVudDsKICAgICAgICAgICAgICAgIHZhciBjb21pY1RpdGxlV29yZHMgPSBjb21pY1RpdGxlLnNwbGl0KCIgIik7CiAgICAgICAgICAgICAgICB2YXIgaXNzdWVOdW1iZXJzID0gY29taWNUaXRsZVdvcmRzLmZpbHRlcihmdW5jdGlvbiAod29yZCkgewogICAgICAgICAgICAgICAgICAgIC8vcmV0dXJuIHdvcmQuc3RhcnRzV2l0aCgiIzAiKSB8fCB3b3JkLnN0YXJ0c1dpdGgoIiMxIikKICAgICAgICAgICAgICAgICAgICBpZiAod29yZCA9PT0gIiMwIiB8fCB3b3JkID09PSAiIzEiKSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAod29yZC5zdGFydHNXaXRoKCIjMCIpIHx8IHdvcmQuc3RhcnRzV2l0aCgiIzEiKSkgewogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gKC9cRC8udGVzdCh3b3JkWzJdKQogICAgICAgICAgICAgICAgICAgICAgICApOwogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIGlmIChpc3N1ZU51bWJlcnMubGVuZ3RoID49IDEpIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRlYnVnKGlzc3VlTnVtYmVycyk7CiAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2coIkZvdW5kIG5ldyBjb21pYzogIiArIGNvbWljVGl0bGUpOwogICAgICAgICAgICAgICAgICAgIGl0ZW0uY2xhc3NMaXN0LmFkZCgibmV3LXNlcmllcyIpOwogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBjb25zb2xlLndhcm4oIkhpZGUgZXhpc3Rpbmcgc2VyaWVzOiAiICsgY29taWNUaXRsZSk7CiAgICAgICAgICAgICAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKCJleGlzdGluZy1zZXJpZXMiKTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfSwgewogICAgICAgIGtleTogInF1ZXJ5TmV3U2VyaWVzIiwKICAgICAgICB2YWx1ZTogZnVuY3Rpb24gcXVlcnlOZXdTZXJpZXMoKSB7CiAgICAgICAgICAgIGlmICh0aGlzLmVuYWJsZWQpIHsKICAgICAgICAgICAgICAgIHZhciByZXF1aXJlc1VwZGF0ZSA9IEJvb2xlYW4odGhpcy50aHVtYkxpc3QucXVlcnlTZWxlY3RvckFsbCgibGk6bm90KC5uZXctc2VyaWVzKTpub3QoLmV4aXN0aW5nLXNlcmllcykiKS5sZW5ndGggPiAwKTsKICAgICAgICAgICAgICAgIHRoaXMuaGlnaGxpZ2h0TmV3U2VyaWVzKCk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIEhpZ2hsaWdodE5ld1NlcmllczsKfSgpOwoKZXhwb3J0cy5IaWdobGlnaHROZXdTZXJpZXMgPSBIaWdobGlnaHROZXdTZXJpZXM7Cgp9LHsiLi9jb29raWUiOjIsIi4vaGVscGVycyI6NH1dLDY6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0oKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKdmFyIGhlbHBlcnNfMSA9IHJlcXVpcmUoIi4vaGVscGVycyIpOwoKdmFyIEluZmluaXRlU2Nyb2xsID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gSW5maW5pdGVTY3JvbGwoKSB7CiAgICAgICAgdmFyIF90aGlzID0gdGhpczsKCiAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIEluZmluaXRlU2Nyb2xsKTsKCiAgICAgICAgdGhpcy5lbmFibGVkID0gdHJ1ZTsKICAgICAgICB0aGlzLmN1cnJlbnRQYWdlID0gMTsKICAgICAgICB0aGlzLnBhZ2VIcmVmcyA9IHt9OwogICAgICAgIHRoaXMudGh1bWJMaXN0ID0gZG9jdW1lbnQucXVlcnlTZWxlY3RvcigiLnRodW1ibGlzdCIpOwogICAgICAgIHZhciBwYWdlciA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoIi5wYWdlciIpOwogICAgICAgIHZhciBpc09uVmFsaWRQYWdlID0gQm9vbGVhbih0aGlzLnRodW1iTGlzdCAmJiBwYWdlciAmJiAocGFnZXIucXVlcnlTZWxlY3RvcigiLnBhZ2UuY3VycmVudCIpIHx8IHsgdGV4dENvbnRlbnQ6IHVuZGVmaW5lZCB9KS50ZXh0Q29udGVudCA9PT0gIjEiKTsKICAgICAgICB0aGlzLmRlYm91bmNlUXVlcnlNb3JlSXRlbXMgPSBoZWxwZXJzXzEuZGVib3VuY2UodGhpcy5xdWVyeU1vcmVJdGVtcy5iaW5kKHRoaXMpLCAyNTApOwogICAgICAgIGlmICh0aGlzLmVuYWJsZWQgJiYgaXNPblZhbGlkUGFnZSkgewogICAgICAgICAgICBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuZGlzY29ib2x1cyIpLmNsYXNzTGlzdC5hZGQoImluZmluaXRlLXNjcm9sbCIpOwogICAgICAgICAgICB2YXIgcGFnZVBhdGggPSBsb2NhdGlvbi5wYXRobmFtZTsKICAgICAgICAgICAgdmFyIGxhc3RQYWdlRWxtID0gQXJyYXkuZnJvbShwYWdlci5xdWVyeVNlbGVjdG9yQWxsKCIucGFnZSBhIikpLnBvcCgpOwogICAgICAgICAgICBpZiAobGFzdFBhZ2VFbG0pIHsKICAgICAgICAgICAgICAgIHZhciBsYXN0UGFnZSA9IHBhcnNlSW50KGxhc3RQYWdlRWxtLnRleHRDb250ZW50KTsKICAgICAgICAgICAgICAgIGZvciAodmFyIGlkeCA9IDI7IGlkeCA8PSBsYXN0UGFnZTsgaWR4KyspIHsKICAgICAgICAgICAgICAgICAgICB0aGlzLnBhZ2VIcmVmc1tpZHhdID0gcGFnZVBhdGggKyAiLyIgKyBpZHg7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdGhpcy5sb2FkaW5nRWxtID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgiZGl2Iik7CiAgICAgICAgICAgIHRoaXMubG9hZGluZ0VsbS5jbGFzc0xpc3QuYWRkKCJpbmZpbml0ZS1zY3JvbGwtbG9hZGluZyIpOwogICAgICAgICAgICB0aGlzLnRodW1iTGlzdC5pbnNlcnRBZGphY2VudEVsZW1lbnQoImFmdGVyZW5kIiwgdGhpcy5sb2FkaW5nRWxtKTsKICAgICAgICAgICAgdGhpcy5xdWVyeU1vcmVJdGVtcygpOwogICAgICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignc2Nyb2xsJywgZnVuY3Rpb24gKGV2ZW50KSB7CiAgICAgICAgICAgICAgICAvL2NvbnNvbGUuZGVidWcoIlRyaWdnZXIgY2hlY2sgZm9yIG1vcmUgaXRlbXMuIikKICAgICAgICAgICAgICAgIF90aGlzLmRlYm91bmNlUXVlcnlNb3JlSXRlbXMoKTsKICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIC8vIGluY2FzZSB0aGUgbG9hZGluZyBlbGVtZW50IGJlY29tZXMgdmlzaWJsZSBkbyB0byBvdGhlciBmZWF0dXJlcyAoZWcuIEhpZ2hsaWdodCBOZXcgU2VyaWVzKQogICAgICAgICAgICB2YXIgb2JzZXJ2ZXIgPSBuZXcgTXV0YXRpb25PYnNlcnZlcihmdW5jdGlvbiAobXV0YXRpb25zTGlzdCwgb2JzZXJ2ZXIpIHsKICAgICAgICAgICAgICAgIGNvbnNvbGUuZGVidWcoIm11dGF0aW9uIGV2ZW50IiwgbXV0YXRpb25zTGlzdCwgb2JzZXJ2ZXIpOwogICAgICAgICAgICAgICAgX3RoaXMuZGVib3VuY2VRdWVyeU1vcmVJdGVtcygpOwogICAgICAgICAgICB9KTsKICAgICAgICAgICAgb2JzZXJ2ZXIub2JzZXJ2ZSh0aGlzLnRodW1iTGlzdCwgeyBhdHRyaWJ1dGVzOiB0cnVlLCBjaGlsZExpc3Q6IHRydWUsIHN1YnRyZWU6IHRydWUgfSk7CiAgICAgICAgfQogICAgfQoKICAgIF9jcmVhdGVDbGFzcyhJbmZpbml0ZVNjcm9sbCwgW3sKICAgICAgICBrZXk6ICJoYXNNb3JlUGFnZXMiLAogICAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYXNNb3JlUGFnZXMoKSB7CiAgICAgICAgICAgIHZhciBuZXh0UGFnZSA9IHRoaXMuY3VycmVudFBhZ2UgKyAxOwogICAgICAgICAgICByZXR1cm4gQm9vbGVhbih0aGlzLnBhZ2VIcmVmc1tuZXh0UGFnZV0pOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICJnZXROZXh0UGFnZSIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldE5leHRQYWdlKCkgewogICAgICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCiAgICAgICAgICAgIGlmICghdGhpcy5oYXNNb3JlUGFnZXMoKSkgewogICAgICAgICAgICAgICAgcmV0dXJuIFByb21pc2UucmVqZWN0KG5ldyBFcnJvcigiTm8gbW9yZSBwYWdlcy4iKSk7CiAgICAgICAgICAgIH0KICAgICAgICAgICAgdmFyIG5leHRQYWdlID0gdGhpcy5jdXJyZW50UGFnZSArIDE7CiAgICAgICAgICAgIHJldHVybiBoZWxwZXJzXzEuZ2V0UGFnZURvbSh0aGlzLnBhZ2VIcmVmc1tuZXh0UGFnZV0pLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlRG9tKSB7CiAgICAgICAgICAgICAgICB2YXIgbmV3VGh1bWJMaXN0ID0gcmVzcG9uc2VEb20ucXVlcnlTZWxlY3RvcigiLnRodW1ibGlzdCIpOwogICAgICAgICAgICAgICAgaWYgKCFuZXdUaHVtYkxpc3QpIHsKICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoIk5vIGl0ZW1zIGZvdW5kLiIpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgQXJyYXkuZnJvbShuZXdUaHVtYkxpc3QuY2hpbGRyZW4pLmZvckVhY2goZnVuY3Rpb24gKGVsbSkgewogICAgICAgICAgICAgICAgICAgIF90aGlzMi50aHVtYkxpc3QuYXBwZW5kQ2hpbGQoZWxtKTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgX3RoaXMyLmN1cnJlbnRQYWdlID0gbmV4dFBhZ2U7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICJxdWVyeU1vcmVJdGVtcyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHF1ZXJ5TW9yZUl0ZW1zKCkgewogICAgICAgICAgICB2YXIgX3RoaXMzID0gdGhpczsKCiAgICAgICAgICAgIHZhciBpc0xvYWRpbmcgPSB0aGlzLmxvYWRpbmdFbG0uY2xhc3NMaXN0LmNvbnRhaW5zKCJhY3RpdmUiKTsKICAgICAgICAgICAgaWYgKCFpc0xvYWRpbmcgJiYgaGVscGVyc18xLmlzSW5WaWV3cG9ydCh0aGlzLmxvYWRpbmdFbG0pICYmIHRoaXMuaGFzTW9yZVBhZ2VzKCkpIHsKICAgICAgICAgICAgICAgIHRoaXMubG9hZGluZ0VsbS5jbGFzc0xpc3QuYWRkKCJhY3RpdmUiKTsKICAgICAgICAgICAgICAgIHRoaXMuZ2V0TmV4dFBhZ2UoKS50aGVuKGZ1bmN0aW9uICgpIHsKICAgICAgICAgICAgICAgICAgICBfdGhpczMubG9hZGluZ0VsbS5jbGFzc0xpc3QucmVtb3ZlKCJhY3RpdmUiKTsKICAgICAgICAgICAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlcnJvcikgewogICAgICAgICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoZXJyb3IpOwogICAgICAgICAgICAgICAgICAgIF90aGlzMy5sb2FkaW5nRWxtLmNsYXNzTGlzdC5yZW1vdmUoImFjdGl2ZSIpOwogICAgICAgICAgICAgICAgfSk7CiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIEluZmluaXRlU2Nyb2xsOwp9KCk7CgpleHBvcnRzLkluZmluaXRlU2Nyb2xsID0gSW5maW5pdGVTY3JvbGw7Cgp9LHsiLi9oZWxwZXJzIjo0fV0sNzpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CnZhciBncmVldF8xID0gcmVxdWlyZSgiLi9ncmVldCIpOwp2YXIgY29va2llXzEgPSByZXF1aXJlKCIuL2Nvb2tpZSIpOwp2YXIgaGlnaGxpZ2h0X25ld19zZXJpZXNfMSA9IHJlcXVpcmUoIi4vaGlnaGxpZ2h0LW5ldy1zZXJpZXMiKTsKdmFyIGluZmluaXRlX3Njcm9sbF8xID0gcmVxdWlyZSgiLi9pbmZpbml0ZS1zY3JvbGwiKTsKdmFyIG9yZGVyX2hpc3Rvcnlfc3RhdHVzXzEgPSByZXF1aXJlKCIuL29yZGVyLWhpc3Rvcnktc3RhdHVzIik7Ci8vaW1wb3J0IHsgU2V0dGluZ3NQYWdlIH0gZnJvbSAiLi9zZXR0aW5ncy1wYWdlIgpjb25zb2xlLmxvZyhncmVldF8xLnNheUhlbGxvKCJUeXBlU2NyaXB0IikpOwp2YXIgaGlnaGxpZ2h0TmV3U2VyaWVzID0gbmV3IGhpZ2hsaWdodF9uZXdfc2VyaWVzXzEuSGlnaGxpZ2h0TmV3U2VyaWVzKCk7CnZhciBpbmZpbml0ZVNjcm9sbCA9IG5ldyBpbmZpbml0ZV9zY3JvbGxfMS5JbmZpbml0ZVNjcm9sbCgpOwp2YXIgb3JkZXJIaXN0b3J5U3RhdHVzID0gbmV3IG9yZGVyX2hpc3Rvcnlfc3RhdHVzXzEuT3JkZXJIaXN0b3J5U3RhdHVzKCk7CndpbmRvdy5kaXNjb2JvbHVzID0ge307CndpbmRvdy5kaXNjb2JvbHVzLmhpZ2hsaWdodE5ld1NlcmllcyA9IGhpZ2hsaWdodE5ld1NlcmllczsKd2luZG93LmRpc2NvYm9sdXMuQ29va2llID0gY29va2llXzEuQ29va2llOwp3aW5kb3cuZGlzY29ib2x1cy5pbmZpbml0ZVNjcm9sbCA9IGluZmluaXRlU2Nyb2xsOwp3aW5kb3cuZGlzY29ib2x1cy5vcmRlckhpc3RvcnlTdGF0dXMgPSBvcmRlckhpc3RvcnlTdGF0dXM7Ci8vd2luZG93LmRpc2NvYm9sdXMuc2V0dGluZ3NQYWdlID0gc2V0dGluZ3NQYWdlCgp9LHsiLi9jb29raWUiOjIsIi4vZ3JlZXQiOjMsIi4vaGlnaGxpZ2h0LW5ldy1zZXJpZXMiOjUsIi4vaW5maW5pdGUtc2Nyb2xsIjo2LCIuL29yZGVyLWhpc3Rvcnktc3RhdHVzIjo5fV0sODpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKY29uc3QgcHJlYWN0XzEgPSByZXF1aXJlKCJwcmVhY3QiKTsKY29uc3QgcmVuZGVyX2VsZW1lbnRfMSA9IHJlcXVpcmUoIi4vcmVuZGVyLWVsZW1lbnQiKTsKY2xhc3MgU3RhdHVzSGVhZGVyIGV4dGVuZHMgcHJlYWN0XzEuQ29tcG9uZW50IHsKICAgIHJlbmRlcigpIHsKICAgICAgICByZXR1cm4gKHByZWFjdF8xLmgoInRoIiwgeyBjbGFzczogIm9yZGVyLXN0YXR1cyByaWdodGVkIiB9LCAiU3RhdHVzIikpOwogICAgfQp9CmNsYXNzIFN0YXR1cyBleHRlbmRzIHByZWFjdF8xLkNvbXBvbmVudCB7CiAgICBjb25zdHJ1Y3Rvcihwcm9wcykgewogICAgICAgIHN1cGVyKHByb3BzKTsKICAgICAgICB0aGlzLnN0YXRlLnByb2Nlc3NpbmcgPSAiLSI7CiAgICAgICAgdGhpcy5zdGF0ZS5maWxsZWQgPSAiLSI7CiAgICAgICAgdGhpcy5zdGF0ZS5zaGlwcGVkID0gIi0iOwogICAgICAgIHRoaXMuc3RhdGUuY2FuY2VsbGVkID0gIi0iOwogICAgICAgIC8vIFRoaXMgYmluZGluZyBpcyBuZWNlc3NhcnkgdG8gbWFrZSBgdGhpc2Agd29yayBpbiB0aGUgY2FsbGJhY2sKICAgICAgICB0aGlzLmhhbmRsZVN0YXR1cyA9IHRoaXMuaGFuZGxlU3RhdHVzLmJpbmQodGhpcyk7CiAgICB9CiAgICBoYW5kbGVTdGF0dXMoZXZlbnQpIHsKICAgICAgICBpZiAoZXZlbnQuZGV0YWlsLmxpbmsgPT0gdGhpcy5wcm9wcy5ocmVmKSB7CiAgICAgICAgICAgIHRoaXMuc2V0U3RhdGUoewogICAgICAgICAgICAgICAgcHJvY2Vzc2luZzogZXZlbnQuZGV0YWlsLnByb2Nlc3NpbmcsCiAgICAgICAgICAgICAgICBmaWxsZWQ6IGV2ZW50LmRldGFpbC5maWxsZWQsCiAgICAgICAgICAgICAgICBzaGlwcGVkOiBldmVudC5kZXRhaWwuc2hpcHBlZCwKICAgICAgICAgICAgICAgIGNhbmNlbGxlZDogZXZlbnQuZGV0YWlsLmNhbmNlbGxlZCwKICAgICAgICAgICAgfSk7CiAgICAgICAgfQogICAgfQogICAgY29tcG9uZW50RGlkTW91bnQoKSB7CiAgICAgICAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcigib3JkZXItc3RhdHVzIiwgdGhpcy5oYW5kbGVTdGF0dXMpOwogICAgfQogICAgY29tcG9uZW50V2lsbFVubW91bnQoKSB7CiAgICAgICAgZG9jdW1lbnQucmVtb3ZlRXZlbnRMaXN0ZW5lcigib3JkZXItc3RhdHVzIiwgdGhpcy5oYW5kbGVTdGF0dXMpOwogICAgfQogICAgcmVuZGVyKHByb3BzLCBzdGF0ZSkgewogICAgICAgIGxldCBwcm9jZXNzaW5nVGl0bGUgPSBgUHJvY2Vzc2luZzogJHtzdGF0ZS5wcm9jZXNzaW5nfWA7CiAgICAgICAgbGV0IGZpbGxlZFRpdGxlID0gYEZpbGxlZDogJHtzdGF0ZS5maWxsZWR9YDsKICAgICAgICBsZXQgc2hpcHBlZFRpdGxlID0gYFNoaXBwZWQ6ICR7c3RhdGUuc2hpcHBlZH1gOwogICAgICAgIGxldCBjYW5jZWxsZWRUaXRsZSA9IGBDYW5jZWxsZWQ6ICR7c3RhdGUuY2FuY2VsbGVkfWA7CiAgICAgICAgcmV0dXJuIChwcmVhY3RfMS5oKCJ0ZCIsIHsgY2xhc3M6ICJvcmRlci1zdGF0dXMgcmlnaHRlZCIgfSwKICAgICAgICAgICAgcHJlYWN0XzEuaCgic3BhbiIsIHsgdGl0bGU6IHByb2Nlc3NpbmdUaXRsZSB9LAogICAgICAgICAgICAgICAgIlA6IiwKICAgICAgICAgICAgICAgIHN0YXRlLnByb2Nlc3NpbmcpLAogICAgICAgICAgICBwcmVhY3RfMS5oKCJzcGFuIiwgeyB0aXRsZTogZmlsbGVkVGl0bGUgfSwKICAgICAgICAgICAgICAgICJGOiIsCiAgICAgICAgICAgICAgICBzdGF0ZS5maWxsZWQpLAogICAgICAgICAgICBwcmVhY3RfMS5oKCJzcGFuIiwgeyB0aXRsZTogc2hpcHBlZFRpdGxlIH0sCiAgICAgICAgICAgICAgICAiUzoiLAogICAgICAgICAgICAgICAgc3RhdGUuc2hpcHBlZCksCiAgICAgICAgICAgIHByZWFjdF8xLmgoInNwYW4iLCB7IHRpdGxlOiBjYW5jZWxsZWRUaXRsZSB9LAogICAgICAgICAgICAgICAgIkM6IiwKICAgICAgICAgICAgICAgIHN0YXRlLmNhbmNlbGxlZCkpKTsKICAgIH0KfQpjbGFzcyBUb3RhbEhlYWRlciBleHRlbmRzIHByZWFjdF8xLkNvbXBvbmVudCB7CiAgICByZW5kZXIoKSB7CiAgICAgICAgcmV0dXJuIChwcmVhY3RfMS5oKCJ0aCIsIHsgY2xhc3M6ICJvcmRlci1pdGVtcyByaWdodGVkIiB9LCAiSXRlbXMiKSk7CiAgICB9Cn0KY2xhc3MgVG90YWwgZXh0ZW5kcyBwcmVhY3RfMS5Db21wb25lbnQgewogICAgY29uc3RydWN0b3IocHJvcHMpIHsKICAgICAgICBzdXBlcihwcm9wcyk7CiAgICAgICAgdGhpcy5zdGF0ZS50b3RhbCA9ICItIjsKICAgICAgICAvLyBUaGlzIGJpbmRpbmcgaXMgbmVjZXNzYXJ5IHRvIG1ha2UgYHRoaXNgIHdvcmsgaW4gdGhlIGNhbGxiYWNrCiAgICAgICAgdGhpcy5oYW5kbGVTdGF0dXMgPSB0aGlzLmhhbmRsZVN0YXR1cy5iaW5kKHRoaXMpOwogICAgfQogICAgaGFuZGxlU3RhdHVzKGV2ZW50KSB7CiAgICAgICAgaWYgKGV2ZW50LmRldGFpbC5saW5rID09IHRoaXMucHJvcHMuaHJlZikgewogICAgICAgICAgICB0aGlzLnNldFN0YXRlKHsKICAgICAgICAgICAgICAgIHRvdGFsOiBldmVudC5kZXRhaWwudG90YWwsCiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0KICAgIGNvbXBvbmVudERpZE1vdW50KCkgewogICAgICAgIGRvY3VtZW50LmFkZEV2ZW50TGlzdGVuZXIoIm9yZGVyLXN0YXR1cyIsIHRoaXMuaGFuZGxlU3RhdHVzKTsKICAgIH0KICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkgewogICAgICAgIGRvY3VtZW50LnJlbW92ZUV2ZW50TGlzdGVuZXIoIm9yZGVyLXN0YXR1cyIsIHRoaXMuaGFuZGxlU3RhdHVzKTsKICAgIH0KICAgIHJlbmRlcihwcm9wcywgc3RhdGUpIHsKICAgICAgICByZXR1cm4gKHByZWFjdF8xLmgoInRkIiwgeyBjbGFzczogIm9yZGVyLWl0ZW1zIHJpZ2h0ZWQiIH0sCiAgICAgICAgICAgIHByZWFjdF8xLmgoInNwYW4iLCBudWxsLCBzdGF0ZS50b3RhbCkpKTsKICAgIH0KfQpmdW5jdGlvbiBhZGRUb0hlYWRlclJvdyhyb3cpIHsKICAgIHJvdy5hcHBlbmRDaGlsZChyZW5kZXJfZWxlbWVudF8xLnJlbmRlckVsZW1lbnQocHJlYWN0XzEuaChTdGF0dXNIZWFkZXIsIG51bGwpKSk7CiAgICByb3cuYXBwZW5kQ2hpbGQocmVuZGVyX2VsZW1lbnRfMS5yZW5kZXJFbGVtZW50KHByZWFjdF8xLmgoVG90YWxIZWFkZXIsIG51bGwpKSk7Cn0KZXhwb3J0cy5hZGRUb0hlYWRlclJvdyA9IGFkZFRvSGVhZGVyUm93OwpmdW5jdGlvbiBhZGRUb1Jvdyhyb3csIGhyZWYpIHsKICAgIHJvdy5hcHBlbmRDaGlsZChyZW5kZXJfZWxlbWVudF8xLnJlbmRlckVsZW1lbnQocHJlYWN0XzEuaChTdGF0dXMsIHsgaHJlZjogaHJlZiB9KSkpOwogICAgcm93LmFwcGVuZENoaWxkKHJlbmRlcl9lbGVtZW50XzEucmVuZGVyRWxlbWVudChwcmVhY3RfMS5oKFRvdGFsLCB7IGhyZWY6IGhyZWYgfSkpKTsKfQpleHBvcnRzLmFkZFRvUm93ID0gYWRkVG9Sb3c7Cgp9LHsiLi9yZW5kZXItZWxlbWVudCI6MTAsInByZWFjdCI6MX1dLDk6W2Z1bmN0aW9uKHJlcXVpcmUsbW9kdWxlLGV4cG9ydHMpewoidXNlIHN0cmljdCI7Cgp2YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0oKTsKCmZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKT2JqZWN0LmRlZmluZVByb3BlcnR5KGV4cG9ydHMsICJfX2VzTW9kdWxlIiwgeyB2YWx1ZTogdHJ1ZSB9KTsKdmFyIGhlbHBlcnNfMSA9IHJlcXVpcmUoIi4vaGVscGVycyIpOwp2YXIgb3JkZXJfaGlzdG9yeV9zdGF0dXNfY29tcG9uZW50c18xID0gcmVxdWlyZSgiLi9vcmRlci1oaXN0b3J5LXN0YXR1cy1jb21wb25lbnRzIik7Cgp2YXIgT3JkZXJIaXN0b3J5U3RhdHVzID0gZnVuY3Rpb24gKCkgewogICAgZnVuY3Rpb24gT3JkZXJIaXN0b3J5U3RhdHVzKCkgewogICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBPcmRlckhpc3RvcnlTdGF0dXMpOwoKICAgICAgICBpZiAobG9jYXRpb24ucGF0aG5hbWUgPT09ICIvYWNjb3VudC9vcmRlcnMiKSB7CiAgICAgICAgICAgIHZhciBoZWFkZXJSb3cgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yKCIuY2FydHRhYmxlIHRyIik7CiAgICAgICAgICAgIHZhciBvcmRlckFuY2hvcnMgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoImFbaHJlZio9Jy9hY2NvdW50L29yZGVyLyciKSk7CiAgICAgICAgICAgIG9yZGVyX2hpc3Rvcnlfc3RhdHVzX2NvbXBvbmVudHNfMS5hZGRUb0hlYWRlclJvdyhoZWFkZXJSb3cpOwogICAgICAgICAgICBvcmRlckFuY2hvcnMuZm9yRWFjaChmdW5jdGlvbiAob3JkZXJBbmNob3IpIHsKICAgICAgICAgICAgICAgIHZhciBocmVmID0gb3JkZXJBbmNob3IuZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgICAgICAgICAgICAgICB2YXIgb3JkZXJSb3cgPSBvcmRlckFuY2hvci5wYXJlbnRFbGVtZW50OwogICAgICAgICAgICAgICAgd2hpbGUgKG9yZGVyUm93LnRhZ05hbWUgIT09ICJUUiIgJiYgb3JkZXJSb3cpIHsKICAgICAgICAgICAgICAgICAgICBvcmRlclJvdyA9IG9yZGVyUm93LnBhcmVudEVsZW1lbnQ7CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBpZiAob3JkZXJSb3cpIHsKICAgICAgICAgICAgICAgICAgICBvcmRlcl9oaXN0b3J5X3N0YXR1c19jb21wb25lbnRzXzEuYWRkVG9Sb3cob3JkZXJSb3csIGhyZWYpOwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9KTsKICAgICAgICAgICAgdGhpcy5xdWVyeU9yZGVycygpOwogICAgICAgIH0KICAgIH0KCiAgICBfY3JlYXRlQ2xhc3MoT3JkZXJIaXN0b3J5U3RhdHVzLCBbewogICAgICAgIGtleTogImdldFN0YXR1cyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGdldFN0YXR1cyhvcmRlclVybCkgewogICAgICAgICAgICByZXR1cm4gaGVscGVyc18xLmdldFBhZ2VEb20ob3JkZXJVcmwpLnRoZW4oZnVuY3Rpb24gKHJlc3BvbnNlRG9tKSB7CiAgICAgICAgICAgICAgICB2YXIgcHJvZHVjdFJvd3MgPSBBcnJheS5mcm9tKHJlc3BvbnNlRG9tLnF1ZXJ5U2VsZWN0b3JBbGwoIi5jYXJ0dGFibGUgaW5wdXQuY2FydHF0eSIpKS5tYXAoZnVuY3Rpb24gKGVsbSkgewogICAgICAgICAgICAgICAgICAgIHdoaWxlIChlbG0ucGFyZW50RWxlbWVudCAmJiBlbG0udGFnTmFtZSAhPT0gIlRSIikgewogICAgICAgICAgICAgICAgICAgICAgICBlbG0gPSBlbG0ucGFyZW50RWxlbWVudDsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGVsbTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICAgICAgdmFyIHRvdGFscyA9IHsKICAgICAgICAgICAgICAgICAgICBwcm9jZXNzaW5nOiAwLAogICAgICAgICAgICAgICAgICAgIGZpbGxlZDogMCwKICAgICAgICAgICAgICAgICAgICBzaGlwcGVkOiAwLAogICAgICAgICAgICAgICAgICAgIGNhbmNlbGxlZDogMCwKICAgICAgICAgICAgICAgICAgICB0b3RhbDogMAogICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIHByb2R1Y3RSb3dzLmZvckVhY2goZnVuY3Rpb24gKHByb2R1Y3RSb3cpIHsKICAgICAgICAgICAgICAgICAgICB0b3RhbHMudG90YWwrKzsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdHVzRWxtID0gcHJvZHVjdFJvdy5xdWVyeVNlbGVjdG9yKCIuc3RhdHVzaW1nIik7CiAgICAgICAgICAgICAgICAgICAgaWYgKHN0YXR1c0VsbSkgewogICAgICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdHVzVGV4dCA9IHN0YXR1c0VsbS5nZXRBdHRyaWJ1dGUoInRpdGxlIik7CiAgICAgICAgICAgICAgICAgICAgICAgIHN3aXRjaCAoc3RhdHVzVGV4dC50b1VwcGVyQ2FzZSgpKSB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJQUk9DRVNTSU5HIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbHMucHJvY2Vzc2luZysrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiRklMTEVEIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbHMuZmlsbGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBjYXNlICJTSElQUEVEIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbHMuc2hpcHBlZCsrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJyZWFrOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2FzZSAiQ0FOQ0VMTEVEIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3RhbHMuY2FuY2VsbGVkKys7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWs7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgIHJldHVybiB0b3RhbHM7CiAgICAgICAgICAgIH0pOwogICAgICAgIH0KICAgIH0sIHsKICAgICAgICBrZXk6ICJxdWVyeU9yZGVycyIsCiAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHF1ZXJ5T3JkZXJzKCkgewogICAgICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKICAgICAgICAgICAgdmFyIG9yZGVyTGlua3MgPSBBcnJheS5mcm9tKGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3JBbGwoImFbaHJlZio9Jy9hY2NvdW50L29yZGVyLyciKSkubWFwKGZ1bmN0aW9uIChlbG0pIHsKICAgICAgICAgICAgICAgIHJldHVybiBlbG0uZ2V0QXR0cmlidXRlKCJocmVmIik7CiAgICAgICAgICAgIH0pOwogICAgICAgICAgICBvcmRlckxpbmtzLmZvckVhY2goZnVuY3Rpb24gKGxpbmspIHsKICAgICAgICAgICAgICAgIF90aGlzLmdldFN0YXR1cyhsaW5rKS50aGVuKGZ1bmN0aW9uIChzdGF0dXMpIHsKICAgICAgICAgICAgICAgICAgICB2YXIgZXZlbnREZXRhaWxzID0gT2JqZWN0LmFzc2lnbih7IGxpbms6IGxpbmsgfSwgc3RhdHVzKTsKICAgICAgICAgICAgICAgICAgICB2YXIgc3RhdHVzRXZlbnQgPSBuZXcgQ3VzdG9tRXZlbnQoIm9yZGVyLXN0YXR1cyIsIHsKICAgICAgICAgICAgICAgICAgICAgICAgZGV0YWlsOiBldmVudERldGFpbHMKICAgICAgICAgICAgICAgICAgICB9KTsKICAgICAgICAgICAgICAgICAgICBkb2N1bWVudC5kaXNwYXRjaEV2ZW50KHN0YXR1c0V2ZW50KTsKICAgICAgICAgICAgICAgIH0pOwogICAgICAgICAgICB9KTsKICAgICAgICB9CiAgICB9XSk7CgogICAgcmV0dXJuIE9yZGVySGlzdG9yeVN0YXR1czsKfSgpOwoKZXhwb3J0cy5PcmRlckhpc3RvcnlTdGF0dXMgPSBPcmRlckhpc3RvcnlTdGF0dXM7Cgp9LHsiLi9oZWxwZXJzIjo0LCIuL29yZGVyLWhpc3Rvcnktc3RhdHVzLWNvbXBvbmVudHMiOjh9XSwxMDpbZnVuY3Rpb24ocmVxdWlyZSxtb2R1bGUsZXhwb3J0cyl7CiJ1c2Ugc3RyaWN0IjsKCk9iamVjdC5kZWZpbmVQcm9wZXJ0eShleHBvcnRzLCAiX19lc01vZHVsZSIsIHsgdmFsdWU6IHRydWUgfSk7CnZhciBwcmVhY3RfMSA9IHJlcXVpcmUoInByZWFjdCIpOwpmdW5jdGlvbiByZW5kZXJFbGVtZW50KHZub2RlKSB7CiAgICB2YXIgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVFbGVtZW50KCJkaXYiKTsKICAgIHByZWFjdF8xLnJlbmRlcih2bm9kZSwgZnJhZ21lbnQpOwogICAgcmV0dXJuIGZyYWdtZW50LmNoaWxkcmVuWzBdOwp9CmV4cG9ydHMucmVuZGVyRWxlbWVudCA9IHJlbmRlckVsZW1lbnQ7Cgp9LHsicHJlYWN0IjoxfV19LHt9LFs3XSk7Cg==";

// add Class to html for easier css overrides
elmHtml.classList.add(htmlClass);

// add style to the head
elmStyle = document.createElement("link");
elmStyle.setAttribute('type', "text/css");
elmStyle.setAttribute('rel', "stylesheet");
elmStyle.setAttribute('title', htmlClass);
elmStyle.setAttribute('href', stylesDataUrl);
elmHead.appendChild(elmStyle);

// add javascript to the head
elmScript = document.createElement("script");
elmScript.setAttribute('type','text/javascript');
elmScript.setAttribute('title', htmlClass);
elmScript.setAttribute('src', scriptDataUrl);
elmHead.appendChild(elmScript);
